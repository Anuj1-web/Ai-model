<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wizard Maker — Button Fix (v11 UI + Placeholder)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
    }
    .card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      max-width: 1100px;
      width: 100%;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: .25rem;
    }
    p {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }
    .topbar {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    input[type="file"] {
      padding: .4rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
    }
    button {
      padding: .5rem .9rem;
      border: none;
      border-radius: .5rem;
      background: #111; /* BLACK EXPORT BUTTON */
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover {
      background: #333;
    }
    .tabs {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    .tab {
      padding: .25rem .75rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      background: #f3f4f6;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .tab.active {
      background: #e5e7eb;
      font-weight: bold;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: .5rem;
      background: #fff;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .modal h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    .mb-2 { margin-bottom: .5rem; }
    .mb-3 { margin-bottom: .75rem; }
    .mb-4 { margin-bottom: 1rem; }
    input, select {
      padding: .5rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      width: 100%;
      font-size: .9rem;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
    }
    .actions button {
      flex: 0 0 auto;
    }
    #cancelBtn {
      background: #e5e7eb;
      color: #111;
    }
    #cancelBtn:hover {
      background: #d1d5db;
    }
 /* Wizard Maker Library Sidebar */
#librarySidebar {
  position: fixed;
  right: 0;
  top: 0;
  height: 100vh;
  width: 280px;
  background: #f9fafb;
  border-left: 1px solid #ccc;
  padding: 1rem;
  overflow-y: auto;
  box-shadow: -4px 0 12px rgba(0,0,0,0.05);
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  font-size: 0.85rem;
}

#librarySidebar h3 {
  margin: 0 0 0.5rem 0;
  font-size: 0.95rem;
  font-weight: bold;
}

.library-category {
  margin-bottom: 1rem;
}

.library-item {
  padding: 0.35rem 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.4rem;
  margin-bottom: 0.35rem;
  cursor: grab;
  background: #fff;
}

.library-item:hover {
  background: #e5e7eb;
}

.library-item.dragging {
  opacity: 0.6;
}

#pageNavContainer {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.5rem;
  background: rgba(255,255,255,0.95);
  padding: 0.5rem 1rem;
  border-radius: 0.5rem 0.5rem 0 0;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  z-index: 90;
}

#pageNavContainer button {
  padding: 0.4rem 0.7rem;
  border-radius: 0.4rem;
  border: 1px solid #ccc;
  background: #f3f4f6;
  cursor: pointer;
  font-size: 0.85rem;
}

#pageNavContainer button.active {
  font-weight: bold;
  background: #e5e7eb;
}
  </style>
</head>
<body>
  <div class="card">
    <h1>Wizard Maker — Button Fix (v11)</h1>
    <p>Upload EduPro (multi-page). Double-click or double-tap buttons/links/inputs to edit. Cancel fully restores. Fonts untouched.</p>

    <div class="topbar">
      <input type="file" id="zipInput" accept=".zip">
      <button id="exportBtn">⬇ Export ZIP</button>
    </div>

    <div class="tabs" id="tabs"></div>
    <div id="iframeContainer"></div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h2>Edit Element</h2>
      <div id="textSection" class="mb-4">
        <label class="mb-2">Text / Placeholder</label>
        <input id="modalText">
      </div>
      <div class="mb-3">
        <label class="mb-2">Color Mode</label>
        <select id="colorTarget">
          <option value="auto">Auto</option>
          <option value="text">Text Color</option>
          <option value="background">Background</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="mb-2">Color Picker</label>
        <input type="color" id="modalColor" style="width:70px;">
      </div>
      <div class="mb-4">
        <label class="mb-2">Replace Image</label>
        <input type="url" id="imageUrl" placeholder="Image URL">
        <input type="file" id="imageFile" accept="image/*">
      </div>
      <div class="actions">
        <button id="cancelBtn">Cancel</button>
        <button id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const zipInput = document.getElementById("zipInput");
    const exportBtn = document.getElementById("exportBtn");
    const tabsEl = document.getElementById("tabs");
    const iframeContainer = document.getElementById("iframeContainer");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalText = document.getElementById("modalText");
    const modalColor = document.getElementById("modalColor");
    const colorTargetSel = document.getElementById("colorTarget");
    const imageUrl = document.getElementById("imageUrl");
    const imageFile = document.getElementById("imageFile");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    let pages = [];
    let pageContents = {};
    let editedContents = {};
    let otherFiles = {};
    let activePage = "";
    let iframeRefs = {};

    let modalTarget = { page: "", id: "", hasText: false, hasPlaceholder: false };
    let originalSnapshot = null;

    // --- File handling ---
    zipInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const zip = await JSZip.loadAsync(file);
      const newPages = [];
      const newContents = {};
      const other = {};

      await Promise.all(Object.keys(zip.files).map(async (filename) => {
        const entry = zip.files[filename];
        if (entry.dir) return;
        if (filename.toLowerCase().endsWith(".html")) {
          const data = await entry.async("string");
          newPages.push(filename);
          newContents[filename] = data;
        } else {
          const data = await entry.async("uint8array");
          other[filename] = data;
        }
      }));

      newPages.sort((a,b) => {
        const ai = /(^|\/)index\.html$/i.test(a);
        const bi = /(^|\/)index\.html$/i.test(b);
        if (ai && !bi) return -1;
        if (!ai && bi) return 1;
        return a.localeCompare(b);
      });

      pages = newPages;
      pageContents = newContents;
      editedContents = {...newContents};
      otherFiles = other;
      activePage = newPages[0] || "";

      renderTabs();
      renderIframes();
    });

    function renderTabs() {
      tabsEl.innerHTML = "";
      pages.forEach((p) => {
        const tab = document.createElement("div");
        tab.className = "tab" + (p === activePage ? " active" : "");
        tab.textContent = p;
        tab.onclick = () => { activePage = p; renderTabs(); renderIframes(); };
        tabsEl.appendChild(tab);
      });
    }

    function injectEditingBridge(html, pageName) {
      const bridge = `<script>(function(){
        var EDIT_ATTR='data-edit-id';
        var clickTimers={};
        function ensureId(el){if(!el.getAttribute(EDIT_ATTR)) el.setAttribute(EDIT_ATTR,'e'+Math.random().toString(36).slice(2,9));return el.getAttribute(EDIT_ATTR);}
        function buildSnapshot(el){return {
          html: el.innerHTML || '',
          text: el.innerText || '',
          placeholder: ('placeholder' in el ? el.placeholder || undefined : undefined),
          src: (el.tagName==='IMG'?(el.getAttribute('src')||el.src||''):undefined),
          inline:{color:el.style.color,backgroundColor:el.style.backgroundColor}
        };}
        document.addEventListener('click',function(e){
          var el=e.target;if(!el)return;
          var tn=(el.tagName||'').toUpperCase();
          if(tn==='A'||tn==='BUTTON'||tn==='INPUT'||tn==='TEXTAREA'){
            var id=ensureId(el);
            e.preventDefault();e.stopPropagation();
            if(clickTimers[id]){
              clearTimeout(clickTimers[id]);clickTimers[id]=null;
              var snap=buildSnapshot(el);
              parent.postMessage({type:'OPEN_EDITOR',page:'${pageName}',id:id,
                hasText:!!el.innerText,
                hasPlaceholder:('placeholder' in el),
                ...snap},'*');
            }else{
              clickTimers[id]=setTimeout(function(){
                clickTimers[id]=null;
                var href=(el.tagName==='A'&&el.href)?el.href:null;
                if(href) window.location.href=href; else el.click();
              },300);
            }
          }
        },true);
        document.addEventListener('dblclick',function(e){
          var el=e.target;if(!el)return;
          e.preventDefault();e.stopPropagation();
          var id=ensureId(el);
          var snap=buildSnapshot(el);
          parent.postMessage({type:'OPEN_EDITOR',page:'${pageName}',id:id,
            hasText:!!el.innerText,
            hasPlaceholder:('placeholder' in el),
            ...snap},'*');
        },true);
        window.addEventListener('message',function(ev){
          var d=ev.data||{};
          var el=document.querySelector('['+EDIT_ATTR+'="'+d.id+'"]');
          if(!el)return;
          if(d.type==='APPLY_TEXT'){
            if('placeholder' in el) el.placeholder=d.text||''; else el.innerText=d.text||'';
          }
          if(d.type==='APPLY_COLOR'){if(d.target==='background')el.style.backgroundColor=d.color;else el.style.color=d.color;}
          if(d.type==='APPLY_IMAGE'&&el.tagName==='IMG')el.src=d.src;
          if(d.type==='RESTORE_ELEMENT'&&d.snapshot){
            if(d.snapshot.html!==undefined && !('placeholder' in el)) el.innerHTML=d.snapshot.html;
            if(d.snapshot.placeholder!==undefined && 'placeholder' in el) el.placeholder=d.snapshot.placeholder;
            if(d.snapshot.src!==undefined&&el.tagName==='IMG')el.src=d.snapshot.src;
            if(d.snapshot.inline){el.style.color=d.snapshot.inline.color||'';el.style.backgroundColor=d.snapshot.inline.backgroundColor||'';}
          }
        });
      })();<\/script>`;
      return html.replace(/<\/body>/i, bridge + "</body>");
    }

    function renderIframes() {
      iframeContainer.innerHTML = "";
      if (!activePage) return;
      const iframe = document.createElement("iframe");
      iframe.srcdoc = injectEditingBridge(editedContents[activePage] || pageContents[activePage] || "", activePage);
      iframeContainer.appendChild(iframe);
      iframeRefs[activePage] = iframe;
    }

    window.addEventListener("message", (event) => {
      const d = event.data || {};
      if (d.type === "OPEN_EDITOR") {
        modalTarget = { page: d.page, id: d.id, hasText: !!d.hasText, hasPlaceholder: !!d.hasPlaceholder };
        modalText.value = d.hasPlaceholder ? d.placeholder || "" : (d.text || "");
        modalColor.value = "#000000";
        originalSnapshot = d;
        modalBackdrop.style.display = "flex";
        document.getElementById("textSection").style.display = (d.hasText || d.hasPlaceholder) ? "block" : "none";
      }
    });

    modalText.addEventListener("input", () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_TEXT",id,text:modalText.value},"*");
    });

    modalColor.addEventListener("input", () => {
      const {page,id,hasText} = modalTarget;
      const target = colorTargetSel.value==="auto" ? (hasText ? "color" : "background") : colorTargetSel.value;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_COLOR",id,color:modalColor.value,target},"*");
    });

    imageUrl.addEventListener("input", () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:imageUrl.value},"*");
    });

    imageFile.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const {page,id} = modalTarget;
        iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:reader.result},"*");
      };
      reader.readAsDataURL(file);
    });

    saveBtn.onclick = () => {
      const {page} = modalTarget;
      const iframe = iframeRefs[page];
      if (iframe.contentDocument) {
        const html = "<!DOCTYPE html>" + iframe.contentDocument.documentElement.outerHTML;
        editedContents[page] = html;
      }
      modalBackdrop.style.display = "none";
    };

    cancelBtn.onclick = () => {
      const {page,id} = modalTarget;
      const iframe = iframeRefs[page];
      if (iframe?.contentWindow && originalSnapshot) {
        iframe.contentWindow.postMessage({type:"RESTORE_ELEMENT",id,snapshot:originalSnapshot},"*");
      }
      modalBackdrop.style.display = "none";
    };

    exportBtn.addEventListener("click", async () => {
      const zip = new JSZip();
      pages.forEach((filename) => {
        const html = editedContents[filename] || pageContents[filename] || "";
        zip.file(filename, html);
      });
      Object.entries(otherFiles).forEach(([filename, data]) => {
        zip.file(filename, data);
      });
      const blob = await zip.generateAsync({type:"blob"});
      saveAs(blob, "custom-site.zip");
    });
  </script>
<script>
  function autoLoadTemplate() {
    const templateData = localStorage.getItem("wizardTemplate");
    if (!templateData) return;

    try {
      // Decode base64 zip string back into a Blob
      const binary = atob(templateData.split(',')[1]);
      const array = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        array[i] = binary.charCodeAt(i);
      }
      const blob = new Blob([array], { type: "application/zip" });
      const file = new File([blob], "template.zip", { type: "application/zip" });

      // Feed the file into zipInput
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      const zipInput = document.getElementById("zipInput");
      zipInput.files = dataTransfer.files;

      // Trigger the change event to load into editor
      zipInput.dispatchEvent(new Event("change", { bubbles: true }));

      // Clear storage so it doesn’t auto-load next time accidentally
      localStorage.removeItem("wizardTemplate");
    } catch (err) {
      console.error("Template auto-load failed:", err);
    }
  }
  autoLoadTemplate();
</script>
<!-- ================== LIBRARY SIDEBAR & DRAG-DROP ================== -->
<style>
  #librarySidebar {
    position: fixed;
    top: 80px;
    right: 10px;
    width: 220px;
    max-height: 80vh;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 0.5rem;
    padding: 0.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
  }
  #librarySidebar h3 { margin: 0 0 0.5rem 0; font-size: 1rem; text-align: center; }
  .library-item {
    padding: 0.4rem;
    margin: 0.25rem 0;
    background: #f3f4f6;
    border-radius: 0.25rem;
    cursor: grab;
    text-align: center;
    font-size: 0.85rem;
  }
  .library-item.dragging { opacity: 0.6; }
  #librarySidebar button { width: 100%; margin-top: 0.5rem; padding: 0.4rem; font-size: 0.85rem; }
</style>

<div id="librarySidebar">
  <h3>Library</h3>
  <div id="libraryContainer"></div>
  <button id="addBoxBtn">+ Add Box/Card</button>
  <button id="addHeaderBtn">+ Add Header</button>
  <button id="addFooterBtn">+ Add Footer</button>
  <button id="addPageBtn">+ Add Page</button>
</div>

<script>
  // -------- Library Items --------
  let libraryItems = [
    { id: 'box1', type: 'box', name: 'Box Card 1', content: '<div class="boxcard">Double-click to edit</div>' },
    { id: 'header1', type: 'header', name: 'Header 1', content: '<header>Header Text</header>' },
    { id: 'footer1', type: 'footer', name: 'Footer 1', content: '<footer>Footer Text</footer>' },
    { id: 'page1', type: 'page', name: 'New Page', content: '<!DOCTYPE html><html><body><h1>New Page</h1></body></html>' }
  ];

  function renderLibrary() {
    const container = document.getElementById('libraryContainer');
    container.innerHTML = '';
    libraryItems.forEach(item => {
      const div = document.createElement('div');
      div.className = 'library-item';
      div.draggable = true;
      div.dataset.id = item.id;
      div.dataset.type = item.type;
      div.innerText = item.name;
      div.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', item.id);
        div.classList.add('dragging');
      });
      div.addEventListener('dragend', e => {
        div.classList.remove('dragging');
      });
      container.appendChild(div);
    });
  }
  renderLibrary();

  // -------- Drag-Drop Insertion --------
  function enableDrop() {
    const iframe = iframeRefs[activePage];
    if (!iframe) return;
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.body.addEventListener('dragover', e => e.preventDefault());
    doc.body.addEventListener('drop', e => {
      e.preventDefault();
      const id = e.dataTransfer.getData('text/plain');
      const item = libraryItems.find(i => i.id === id);
      if (item) {
        const temp = document.createElement('div');
        temp.innerHTML = item.content;
        doc.body.appendChild(temp.firstChild);
        // Save immediately to editedContents
        editedContents[activePage] = "<!DOCTYPE html>" + doc.documentElement.outerHTML;
      }
    });
  }

  // Call after every iframe render
  const originalRenderIframes = renderIframes;
  renderIframes = function() {
    originalRenderIframes();
    enableDrop();
  };

  // -------- Add New Items --------
  function addLibraryItem(type) {
    const name = prompt(`Enter name for new ${type}:`);
    if (!name) return;
    let content = '';
    if (type==='box') content = '<div class="boxcard">Double-click to edit</div>';
    if (type==='header') content = '<header>Header Text</header>';
    if (type==='footer') content = '<footer>Footer Text</footer>';
    if (type==='page') content = `<!DOCTYPE html><html><body><h1>${name}</h1></body></html>`;
    const id = type+'_'+Math.random().toString(36).slice(2,8);
    libraryItems.push({id,type,name,content});
    renderLibrary();
  }

  document.getElementById('addBoxBtn').onclick = ()=> addLibraryItem('box');
  document.getElementById('addHeaderBtn').onclick = ()=> addLibraryItem('header');
  document.getElementById('addFooterBtn').onclick = ()=> addLibraryItem('footer');
  document.getElementById('addPageBtn').onclick = ()=> addLibraryItem('page');
</script>


</body>
</html>
