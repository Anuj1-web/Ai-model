<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wizard Maker â€” Button Fix (v11 UI + Placeholder)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
    }
    .card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      max-width: 1100px;
      width: 100%;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: .25rem;
    }
    p {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }
    .topbar {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    input[type="file"] {
      padding: .4rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
    }
    button {
      padding: .5rem .9rem;
      border: none;
      border-radius: .5rem;
      background: #111; /* BLACK EXPORT BUTTON */
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover {
      background: #333;
    }
    .tabs {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    .tab {
      padding: .25rem .75rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      background: #f3f4f6;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .tab.active {
      background: #e5e7eb;
      font-weight: bold;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: .5rem;
      background: #fff;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .modal h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    .mb-2 { margin-bottom: .5rem; }
    .mb-3 { margin-bottom: .75rem; }
    .mb-4 { margin-bottom: 1rem; }
    input, select {
      padding: .5rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      width: 100%;
      font-size: .9rem;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
    }
    .actions button {
      flex: 0 0 auto;
    }
    #cancelBtn {
      background: #e5e7eb;
      color: #111;
    }
    #cancelBtn:hover {
      background: #d1d5db;
    }
 /* Wizard Maker Library Sidebar */
#librarySidebar {
  position: fixed;
  right: 0;
  top: 0;
  height: 100vh;
  width: 280px;
  background: #f9fafb;
  border-left: 1px solid #ccc;
  padding: 1rem;
  overflow-y: auto;
  box-shadow: -4px 0 12px rgba(0,0,0,0.05);
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  font-size: 0.85rem;
}

#librarySidebar h3 {
  margin: 0 0 0.5rem 0;
  font-size: 0.95rem;
  font-weight: bold;
}

.library-category {
  margin-bottom: 1rem;
}

.library-item {
  padding: 0.35rem 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.4rem;
  margin-bottom: 0.35rem;
  cursor: grab;
  background: #fff;
}

.library-item:hover {
  background: #e5e7eb;
}

.library-item.dragging {
  opacity: 0.6;
}

#pageNavContainer {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.5rem;
  background: rgba(255,255,255,0.95);
  padding: 0.5rem 1rem;
  border-radius: 0.5rem 0.5rem 0 0;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  z-index: 90;
}

#pageNavContainer button {
  padding: 0.4rem 0.7rem;
  border-radius: 0.4rem;
  border: 1px solid #ccc;
  background: #f3f4f6;
  cursor: pointer;
  font-size: 0.85rem;
}

#pageNavContainer button.active {
  font-weight: bold;
  background: #e5e7eb;
}
  </style>
</head>
<body>
  <div class="card">
    <h1>Wizard Maker â€” Button Fix (v11)</h1>
    <p>Upload EduPro (multi-page). Double-click or double-tap buttons/links/inputs to edit. Cancel fully restores. Fonts untouched.</p>

    <div class="topbar">
      <input type="file" id="zipInput" accept=".zip">
      <button id="exportBtn">â¬‡ Export ZIP</button>
    </div>

    <div class="tabs" id="tabs"></div>
    <div id="iframeContainer"></div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h2>Edit Element</h2>
      <div id="textSection" class="mb-4">
        <label class="mb-2">Text / Placeholder</label>
        <input id="modalText">
      </div>
      <div class="mb-3">
        <label class="mb-2">Color Mode</label>
        <select id="colorTarget">
          <option value="auto">Auto</option>
          <option value="text">Text Color</option>
          <option value="background">Background</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="mb-2">Color Picker</label>
        <input type="color" id="modalColor" style="width:70px;">
      </div>
      <div class="mb-4">
        <label class="mb-2">Replace Image</label>
        <input type="url" id="imageUrl" placeholder="Image URL">
        <input type="file" id="imageFile" accept="image/*">
      </div>
      <div class="actions">
        <button id="cancelBtn">Cancel</button>
        <button id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const zipInput = document.getElementById("zipInput");
    const exportBtn = document.getElementById("exportBtn");
    const tabsEl = document.getElementById("tabs");
    const iframeContainer = document.getElementById("iframeContainer");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalText = document.getElementById("modalText");
    const modalColor = document.getElementById("modalColor");
    const colorTargetSel = document.getElementById("colorTarget");
    const imageUrl = document.getElementById("imageUrl");
    const imageFile = document.getElementById("imageFile");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    let pages = [];
    let pageContents = {};
    let editedContents = {};
    let otherFiles = {};
    let activePage = "";
    let iframeRefs = {};

    let modalTarget = { page: "", id: "", hasText: false, hasPlaceholder: false };
    let originalSnapshot = null;

    // --- File handling ---
    zipInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const zip = await JSZip.loadAsync(file);
      const newPages = [];
      const newContents = {};
      const other = {};

      await Promise.all(Object.keys(zip.files).map(async (filename) => {
        const entry = zip.files[filename];
        if (entry.dir) return;
        if (filename.toLowerCase().endsWith(".html")) {
          const data = await entry.async("string");
          newPages.push(filename);
          newContents[filename] = data;
        } else {
          const data = await entry.async("uint8array");
          other[filename] = data;
        }
      }));

      newPages.sort((a,b) => {
        const ai = /(^|\/)index\.html$/i.test(a);
        const bi = /(^|\/)index\.html$/i.test(b);
        if (ai && !bi) return -1;
        if (!ai && bi) return 1;
        return a.localeCompare(b);
      });

      pages = newPages;
      pageContents = newContents;
      editedContents = {...newContents};
      otherFiles = other;
      activePage = newPages[0] || "";

      renderTabs();
      renderIframes();
    });

    function renderTabs() {
      tabsEl.innerHTML = "";
      pages.forEach((p) => {
        const tab = document.createElement("div");
        tab.className = "tab" + (p === activePage ? " active" : "");
        tab.textContent = p;
        tab.onclick = () => { activePage = p; renderTabs(); renderIframes(); };
        tabsEl.appendChild(tab);
      });
    }

    function injectEditingBridge(html, pageName) {
      const bridge = `<script>(function(){
        var EDIT_ATTR='data-edit-id';
        var clickTimers={};
        function ensureId(el){if(!el.getAttribute(EDIT_ATTR)) el.setAttribute(EDIT_ATTR,'e'+Math.random().toString(36).slice(2,9));return el.getAttribute(EDIT_ATTR);}
        function buildSnapshot(el){return {
          html: el.innerHTML || '',
          text: el.innerText || '',
          placeholder: ('placeholder' in el ? el.placeholder || undefined : undefined),
          src: (el.tagName==='IMG'?(el.getAttribute('src')||el.src||''):undefined),
          inline:{color:el.style.color,backgroundColor:el.style.backgroundColor}
        };}
        document.addEventListener('click',function(e){
          var el=e.target;if(!el)return;
          var tn=(el.tagName||'').toUpperCase();
          if(tn==='A'||tn==='BUTTON'||tn==='INPUT'||tn==='TEXTAREA'){
            var id=ensureId(el);
            e.preventDefault();e.stopPropagation();
            if(clickTimers[id]){
              clearTimeout(clickTimers[id]);clickTimers[id]=null;
              var snap=buildSnapshot(el);
              parent.postMessage({type:'OPEN_EDITOR',page:'${pageName}',id:id,
                hasText:!!el.innerText,
                hasPlaceholder:('placeholder' in el),
                ...snap},'*');
            }else{
              clickTimers[id]=setTimeout(function(){
                clickTimers[id]=null;
                var href=(el.tagName==='A'&&el.href)?el.href:null;
                if(href) window.location.href=href; else el.click();
              },300);
            }
          }
        },true);
        document.addEventListener('dblclick',function(e){
          var el=e.target;if(!el)return;
          e.preventDefault();e.stopPropagation();
          var id=ensureId(el);
          var snap=buildSnapshot(el);
          parent.postMessage({type:'OPEN_EDITOR',page:'${pageName}',id:id,
            hasText:!!el.innerText,
            hasPlaceholder:('placeholder' in el),
            ...snap},'*');
        },true);
        window.addEventListener('message',function(ev){
          var d=ev.data||{};
          var el=document.querySelector('['+EDIT_ATTR+'="'+d.id+'"]');
          if(!el)return;
          if(d.type==='APPLY_TEXT'){
            if('placeholder' in el) el.placeholder=d.text||''; else el.innerText=d.text||'';
          }
          if(d.type==='APPLY_COLOR'){if(d.target==='background')el.style.backgroundColor=d.color;else el.style.color=d.color;}
          if(d.type==='APPLY_IMAGE'&&el.tagName==='IMG')el.src=d.src;
          if(d.type==='RESTORE_ELEMENT'&&d.snapshot){
            if(d.snapshot.html!==undefined && !('placeholder' in el)) el.innerHTML=d.snapshot.html;
            if(d.snapshot.placeholder!==undefined && 'placeholder' in el) el.placeholder=d.snapshot.placeholder;
            if(d.snapshot.src!==undefined&&el.tagName==='IMG')el.src=d.snapshot.src;
            if(d.snapshot.inline){el.style.color=d.snapshot.inline.color||'';el.style.backgroundColor=d.snapshot.inline.backgroundColor||'';}
          }
        });
      })();<\/script>`;
      return html.replace(/<\/body>/i, bridge + "</body>");
    }

    function renderIframes() {
      iframeContainer.innerHTML = "";
      if (!activePage) return;
      const iframe = document.createElement("iframe");
      iframe.srcdoc = injectEditingBridge(editedContents[activePage] || pageContents[activePage] || "", activePage);
      iframeContainer.appendChild(iframe);
      iframeRefs[activePage] = iframe;
    }

    window.addEventListener("message", (event) => {
      const d = event.data || {};
      if (d.type === "OPEN_EDITOR") {
        modalTarget = { page: d.page, id: d.id, hasText: !!d.hasText, hasPlaceholder: !!d.hasPlaceholder };
        modalText.value = d.hasPlaceholder ? d.placeholder || "" : (d.text || "");
        modalColor.value = "#000000";
        originalSnapshot = d;
        modalBackdrop.style.display = "flex";
        document.getElementById("textSection").style.display = (d.hasText || d.hasPlaceholder) ? "block" : "none";
      }
    });

    modalText.addEventListener("input", () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_TEXT",id,text:modalText.value},"*");
    });

    modalColor.addEventListener("input", () => {
      const {page,id,hasText} = modalTarget;
      const target = colorTargetSel.value==="auto" ? (hasText ? "color" : "background") : colorTargetSel.value;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_COLOR",id,color:modalColor.value,target},"*");
    });

    imageUrl.addEventListener("input", () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:imageUrl.value},"*");
    });

    imageFile.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const {page,id} = modalTarget;
        iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:reader.result},"*");
      };
      reader.readAsDataURL(file);
    });

    saveBtn.onclick = () => {
      const {page} = modalTarget;
      const iframe = iframeRefs[page];
      if (iframe.contentDocument) {
        const html = "<!DOCTYPE html>" + iframe.contentDocument.documentElement.outerHTML;
        editedContents[page] = html;
      }
      modalBackdrop.style.display = "none";
    };

    cancelBtn.onclick = () => {
      const {page,id} = modalTarget;
      const iframe = iframeRefs[page];
      if (iframe?.contentWindow && originalSnapshot) {
        iframe.contentWindow.postMessage({type:"RESTORE_ELEMENT",id,snapshot:originalSnapshot},"*");
      }
      modalBackdrop.style.display = "none";
    };

    exportBtn.addEventListener("click", async () => {
      const zip = new JSZip();
      pages.forEach((filename) => {
        const html = editedContents[filename] || pageContents[filename] || "";
        zip.file(filename, html);
      });
      Object.entries(otherFiles).forEach(([filename, data]) => {
        zip.file(filename, data);
      });
      const blob = await zip.generateAsync({type:"blob"});
      saveAs(blob, "custom-site.zip");
    });
  </script>
<script>
  function autoLoadTemplate() {
    const templateData = localStorage.getItem("wizardTemplate");
    if (!templateData) return;

    try {
      // Decode base64 zip string back into a Blob
      const binary = atob(templateData.split(',')[1]);
      const array = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        array[i] = binary.charCodeAt(i);
      }
      const blob = new Blob([array], { type: "application/zip" });
      const file = new File([blob], "template.zip", { type: "application/zip" });

      // Feed the file into zipInput
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      const zipInput = document.getElementById("zipInput");
      zipInput.files = dataTransfer.files;

      // Trigger the change event to load into editor
      zipInput.dispatchEvent(new Event("change", { bubbles: true }));

      // Clear storage so it doesnâ€™t auto-load next time accidentally
      localStorage.removeItem("wizardTemplate");
    } catch (err) {
      console.error("Template auto-load failed:", err);
    }
  }
   autoLoadTemplate();
</script>  <!-- âœ… properly close the previous script -->

<!-- ================== LIBRARY SIDEBAR FETCH FROM LIBRARY ================== -->

<!-- Floating black + button -->
<button id="openLibraryBtn" style="
  position: fixed; bottom: 20px; right: 20px;
  width: 50px; height: 50px; border-radius: 50%;
  background: #111; color: #fff; font-size: 2rem;
  border: none; cursor: pointer; z-index: 2000;">+</button>

<!-- Sidebar -->
<div id="librarySidebar" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
    <h3 style="margin:0;color:#fff;">Library Assets</h3>
    <button id="closeLibraryBtn" style="background:none;color:#fff;font-size:1.2rem;border:none;cursor:pointer;">âœ–</button>
  </div>

  <!-- Search -->
  <input type="text" id="librarySearch" placeholder="Search..."
         style="width:100%;padding:0.3rem;margin-bottom:0.5rem;border-radius:0.25rem;border:none;background:#333;color:#fff;">

  <!-- Container -->
  <div id="libraryContainer" style="overflow-y:auto; flex:1;"></div>

  <hr style="border-color:#444;margin:0.5rem 0;">

  <button id="addPageBtnSidebar"
          style="padding:0.4rem;background:#222;color:#fff;border:none;border-radius:0.25rem;cursor:pointer;">
    + Add Blank Page
  </button>
</div>

<style>
#librarySidebar {
  position: fixed;
  top: 0; right: 0;
  width: 320px; height: 100vh;
  background: #111; padding: 1rem;
  box-shadow: -4px 0 12px rgba(0,0,0,0.5);
  z-index: 1500;
  color: #fff;
  display: flex;
  flex-direction: column;
}
.library-category {
  font-weight: bold;
  margin-top: 1rem;
  color: #fff;
}
.library-subcategory {
  font-style: italic;
  font-size: 0.85rem;
  margin-bottom: 0.2rem;
  color: #ccc;
}
.library-item {
  padding: 0.5rem;
  margin-bottom: 0.6rem;
  border-radius: 0.3rem;
  background: #222;
  cursor: pointer;
  color: #fff;
  text-align: center;
}
.library-item:hover { background: #333; }
.library-thumb { max-height: 80px; overflow:hidden; margin-bottom:0.3rem; }
.library-thumb img { max-width: 100%; border-radius:4px; }
.library-title { font-size:0.8rem; color:#ddd; }
</style>

<script>
// ===== Fetch assets from localStorage.sitegenLibrary =====
function getLibraryData(){
  try {
    return JSON.parse(localStorage.getItem("sitegenLibrary") || "[]");
  } catch { return []; }
}

let allAssets = getLibraryData();
// Filter out templates
allAssets = allAssets.filter(item => item.type !== "template");

// Render Sidebar
function renderLibraryAssets(filter=""){
  const container=document.getElementById('libraryContainer');
  container.innerHTML='';

  // Group by type + subcategory
  const categories={};
  allAssets.forEach(item=>{
    const cat=item.type; // asset/page/theme/subscription
    const sub=item.subcategory || "General";
    if(!categories[cat]) categories[cat]={};
    if(!categories[cat][sub]) categories[cat][sub]=[];
    categories[cat][sub].push(item);
  });

  Object.keys(categories).forEach(cat=>{
    const catDiv=document.createElement('div');
    catDiv.className='library-category';
    catDiv.textContent=cat.charAt(0).toUpperCase()+cat.slice(1);
    container.appendChild(catDiv);

    Object.keys(categories[cat]).forEach(sub=>{
      const subDiv=document.createElement('div');
      subDiv.className='library-subcategory';
      subDiv.textContent=sub.charAt(0).toUpperCase()+sub.slice(1);
      container.appendChild(subDiv);

      categories[cat][sub].forEach(item=>{
        if(filter && !item.name.toLowerCase().includes(filter.toLowerCase())) return;

        const div=document.createElement('div');
        div.className='library-item';

        const thumb=document.createElement('div');
        thumb.className='library-thumb';
        if(item.thumbnail){
          const img=document.createElement('img');
          img.src=item.thumbnail;
          thumb.appendChild(img);
        } else {
          const preview=document.createElement('div');
          preview.innerHTML=item.content || "";
          preview.style.transform="scale(0.4)";
          preview.style.transformOrigin="top left";
          preview.style.height="80px";
          preview.style.overflow="hidden";
          thumb.appendChild(preview);
        }

        const title=document.createElement('div');
        title.className='library-title';
        title.innerText=item.name.replace(/[_-]/g," ");

        div.appendChild(thumb);
        div.appendChild(title);

        if(item.type==="page"){
          // full page
          div.addEventListener("click",()=>{
            const filename=item.name.toLowerCase().replace(/\s+/g,'_')+".html";
            pages.push(filename);
            pageContents[filename]=item.content;
            editedContents[filename]=item.content;
            activePage=filename;
            renderTabs();
            renderIframes();
          });
        } else {
          // insert element
          div.addEventListener("click",()=>{
            const iframe=iframeRefs[activePage];
            if(!iframe) return;
            const doc=iframe.contentDocument||iframe.contentWindow.document;
            let insertTarget = doc.activeElement && doc.body.contains(doc.activeElement) ? doc.activeElement : doc.body;
            const temp=document.createElement('div');
            temp.innerHTML=item.content;
            insertTarget.appendChild(temp.firstChild);
            editedContents[activePage]="<!DOCTYPE html>"+doc.documentElement.outerHTML;
          });
          // Drag/drop
          div.draggable=true;
          div.addEventListener('dragstart', e=>{
            e.dataTransfer.setData('text/html', item.content);
            div.classList.add('dragging');
          });
          div.addEventListener('dragend', ()=>div.classList.remove('dragging'));
        }

        container.appendChild(div);
      });
    });
  });
}

// Search
document.getElementById("librarySearch").addEventListener("input",e=>{
  renderLibraryAssets(e.target.value);
});

// Open/close
document.getElementById('openLibraryBtn').onclick=()=>{document.getElementById('librarySidebar').style.display='flex';};
document.getElementById('closeLibraryBtn').onclick=()=>{document.getElementById('librarySidebar').style.display='none';};

// Enable drop inside iframe
function enableDrop(){
  const iframe=iframeRefs[activePage];
  if(!iframe) return;
  const doc=iframe.contentDocument||iframe.contentWindow.document;
  doc.body.addEventListener("dragover", e=>e.preventDefault());
  doc.body.addEventListener("drop", e=>{
    e.preventDefault();
    const html=e.dataTransfer.getData("text/html");
    if(html){
      const temp=document.createElement("div");
      temp.innerHTML=html;
      doc.body.appendChild(temp.firstChild);
      editedContents[activePage]="<!DOCTYPE html>"+doc.documentElement.outerHTML;
    }
  });
}
const originalRenderIframes=renderIframes;
renderIframes=function(){ originalRenderIframes(); enableDrop(); };

// Blank page
document.getElementById('addPageBtnSidebar').onclick=()=>{
  const name=prompt('Enter new page name:');
  if(!name) return;
  const filename=name.replace(/\s+/g,'_').toLowerCase()+'.html';
  const html=`<!DOCTYPE html><html><head><title>${name}</title></head><body><h1>${name}</h1></body></html>`;
  pages.push(filename);
  pageContents[filename]=html;
  editedContents[filename]=html;
  activePage=filename;
  renderTabs();
  renderIframes();
};

// Initial render
renderLibraryAssets();
</script>
<!-- ====================== SGWM THEME ENGINE (ROBUST) â€” START ====================== -->
<style>
  /* ðŸŽ¨ Floating palette button just above your âž• assets button (assumed bottom:20px) */
  #sgwm-theme-toggle {
    position: fixed; bottom: 76px; right: 20px;
    width: 46px; height: 46px; border-radius: 50%;
    background: #ffffff; border: 2px solid #d0d5dd;
    box-shadow: 0 6px 18px rgba(0,0,0,.15);
    cursor: pointer; z-index: 2500; display: grid; place-items: center;
    font-size: 22px; transition: transform .18s, box-shadow .18s, background .18s;
  }
  #sgwm-theme-toggle:hover { transform: translateY(-1px); background:#f8fafc; box-shadow: 0 10px 28px rgba(0,0,0,.18); }

  #sgwm-theme-panel {
    position: fixed; bottom: 132px; right: 20px; width: 380px; max-height: 560px; overflow: auto;
    background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; box-shadow: 0 18px 50px rgba(0,0,0,.18);
    padding: 12px; z-index: 2500; display: none;
  }
  #sgwm-theme-panel h3 { margin: 6px 4px 10px; font-size: 13px; font-weight: 800; letter-spacing: .04em; text-transform: uppercase; color: #374151; }
  .sgwm-theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .sgwm-theme-card {
    display: grid; grid-template-rows: 68px auto; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; cursor: pointer;
    transition: transform .16s, box-shadow .16s, border-color .16s; background: #fff;
  }
  .sgwm-theme-card:hover { transform: translateY(-2px); box-shadow: 0 12px 22px rgba(0,0,0,.10); border-color:#cfd3d9; }
  .sgwm-swatches { display: grid; grid-template-columns: 1fr 1fr 1fr; height: 68px; }
  .sgwm-swatch { width: 100%; height: 100%; }
  .sgwm-theme-name { font-size: 12.5px; font-weight: 700; color:#111827; padding: 8px 10px; border-top: 1px solid #eef2f7; background: #fff; }

  /* small helper toast */
  #sgwm-toast {
    position: fixed; right: 20px; bottom: 190px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
    font-size:12.5px; box-shadow: 0 12px 26px rgba(0,0,0,.2); z-index: 2600; display: none;
  }
</style>

<div id="sgwm-theme-toggle" title="Change Theme">ðŸŽ¨</div>
<div id="sgwm-theme-panel" role="dialog" aria-label="Theme Picker">
  <h3>Choose a Theme</h3>
  <div class="sgwm-theme-grid" id="sgwm-theme-grid"></div>
</div>
<div id="sgwm-toast"></div>

<script>
/* ===================== ROBUST THEME ENGINE ===================== */
/** CORE GOALS
 * 1) Live preview: inject CSS + convert theme.css to blob URL so iframe never 404s
 * 2) Export: write theme.css into ZIP and fix all HTML links in editedContents/pages
 * 3) Robust: repair broken asset references (styles.css vs style.css, case, folders)
 */

/* ---------- Utility: toast ---------- */
function sgwmToast(msg, ms=1800){ const t=document.getElementById('sgwm-toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t.__h); t.__h=setTimeout(()=>t.style.display='none', ms); }

/* ---------- 1) Find live preview iframe ---------- */
let SGWM_PREVIEW = null;
function sgwmFindPreview() {
  const sels = ['#iframeContainer iframe','#previewFrame','#sitePreviewFrame','#editor-preview','#preview','iframe[name="preview"]','.preview iframe','#canvas iframe','iframe[srcdoc]','iframe'];
  for (const s of sels) { const el = document.querySelector(s); if (el) return el; }
  return null;
}
function sgwmAttachPreviewObserver() {
  const tryAttach = () => {
    const f = sgwmFindPreview();
    if (f && f !== SGWM_PREVIEW) {
      SGWM_PREVIEW = f;
      SGWM_PREVIEW.addEventListener('load', async () => {
        /* Re-apply theme + repair links on page switch */
        if (window.__SGWM_CURRENT_THEME_CSS) await sgwmApplyThemeToFrame(SGWM_PREVIEW, window.__SGWM_CURRENT_THEME_CSS);
      }, { passive: true });
      if (window.__SGWM_CURRENT_THEME_CSS) sgwmApplyThemeToFrame(SGWM_PREVIEW, window.__SGWM_CURRENT_THEME_CSS);
    }
  };
  tryAttach();
  const obs = new MutationObserver(tryAttach);
  obs.observe(document.documentElement, { subtree: true, childList: true });
}
document.addEventListener('DOMContentLoaded', sgwmAttachPreviewObserver);

/* ---------- 2) Hook JSZip to capture uploaded ZIP ---------- */
(function sgwmHookZip(){
  try {
    if (window.JSZip && !window.JSZip.__sgwm_patched) {
      const origStatic = window.JSZip.loadAsync;
      if (typeof origStatic === 'function') {
        window.JSZip.loadAsync = function(...args){
          return origStatic.apply(this, args).then(zip => { window.ZIP_REF = zip; window.dispatchEvent(new CustomEvent('sgwm:zip-ready',{detail:{zip}})); return zip; });
        };
      }
      const proto = window.JSZip.prototype || {};
      const origProto = proto.loadAsync;
      if (typeof origProto === 'function') {
        proto.loadAsync = function(...args){
          return origProto.apply(this, args).then(zip => { window.ZIP_REF = zip; window.dispatchEvent(new CustomEvent('sgwm:zip-ready',{detail:{zip}})); return zip; });
        };
      }
      window.JSZip.__sgwm_patched = true;
    }
  } catch(e){ console.warn('[SGWM Theme] JSZip hook failed', e); }
})();

/* Optional manual set */
window.SGWM_THEME = window.SGWM_THEME || {};
window.SGWM_THEME.setZip = function(zip){ window.ZIP_REF = zip; window.dispatchEvent(new CustomEvent('sgwm:zip-ready', { detail: { zip } })); };

/* ---------- 3) Access your editor model ---------- */
const SGWM_MODEL = {
  get pages(){ try { return window.pages || []; } catch { return []; } },
  get edited(){ try { return window.editedContents || {}; } catch { return {}; } },
  raw(name){ return (this.edited[name] ?? (window.pageContents ? window.pageContents[name] : "")) || ""; },
  setEdited(name, html){ if (window.editedContents) window.editedContents[name] = html; }
};

/* ---------- 4) Build a ZIP filename index for robust repairs ---------- */
let SGWM_ZIP_INDEX = null;
async function sgwmBuildZipIndex() {
  if (!window.ZIP_REF) return null;
  const idx = { files: new Set(), lower: new Map(), basenameMap: new Map() };
  Object.keys(window.ZIP_REF.files).forEach(path => {
    const norm = path.replace(/^\.\/+/,'');
    idx.files.add(norm);
    idx.lower.set(norm.toLowerCase(), norm);
    const base = norm.split('/').pop();
    const key = base.toLowerCase();
    if (!idx.basenameMap.has(key)) idx.basenameMap.set(key, []);
    idx.basenameMap.get(key).push(norm);
  });
  SGWM_ZIP_INDEX = idx;
  return idx;
}
function sgwmGuessFileFromIndex(requestPath) {
  if (!SGWM_ZIP_INDEX) return null;
  const q = requestPath.replace(/^\.\/+/,'');
  if (SGWM_ZIP_INDEX.files.has(q)) return q; // exact
  const lower = SGWM_ZIP_INDEX.lower.get(q.toLowerCase());
  if (lower) return lower; // case-insensitive exact

  // Try basename match (handles folder differences)
  const base = q.split('/').pop().toLowerCase();
  const candidates = SGWM_ZIP_INDEX.basenameMap.get(base);
  if (candidates && candidates.length) return candidates[0];

  // Try singular/plural (styles.css <-> style.css)
  if (base === 'styles.css') return SGWM_ZIP_INDEX.basenameMap.get('style.css')?.[0] || null;
  if (base === 'style.css')  return SGWM_ZIP_INDEX.basenameMap.get('styles.css')?.[0] || null;
  if (base === 'scripts.js') return SGWM_ZIP_INDEX.basenameMap.get('script.js')?.[0] || null;
  if (base === 'script.js')  return SGWM_ZIP_INDEX.basenameMap.get('scripts.js')?.[0] || null;

  return null;
}

/* ---------- 5) THEME BASE + 20 UNIQUE THEMES ---------- */
const THEME_BASE_CSS = `
:root{
  --bg:#ffffff;--bg-alt:#f7f7fb;--surface:#ffffff;
  --text:#111827;--muted:#6b7280;
  --primary:#3b82f6;--primary-contrast:#ffffff;
  --accent:#22d3ee;--accent-contrast:#0f172a;
  --border:#e5e7eb;--ring:#93c5fd;--link:#2563eb;--link-hover:#1d4ed8;
  --success:#16a34a;--warning:#f59e0b;--danger:#dc2626;
  --radius:14px;--shadow:0 12px 30px rgba(0,0,0,.12);
}
html,body{background:var(--bg);color:var(--text);}
section, .section, .panel, .container, .content, main {
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:24px;box-shadow:var(--shadow);
}
a{color:var(--link);text-decoration:none;transition:color .2s;}
a:hover{color:var(--link-hover);}
button, .btn, input[type="submit"], .button {
  display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
  padding:.65rem 1rem;border-radius:12px;border:1px solid var(--border);
  background:var(--surface);color:var(--text);transition:all .18s;cursor:pointer;
}
button:hover, .btn:hover { transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.08); }
.btn-primary, .button.primary { background:var(--primary); color:var(--primary-contrast); border-color:transparent; }
.btn-outline { background:transparent; border-color:var(--primary); color:var(--primary); }
.btn-accent  { background:var(--accent);  color:var(--accent-contrast); border-color:transparent; }
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow);}
.card .card-title{font-size:1.125rem;font-weight:700;margin-bottom:.35rem;}
.card .card-sub{color:var(--muted);font-size:.9rem;margin-bottom:.75rem;}
input, select, textarea { background:#fff;border:1px solid var(--border);border-radius:12px;padding:.6rem .7rem; outline: none; }
input:focus, select:focus, textarea:focus { border-color:var(--ring); box-shadow: 0 0 0 3px var(--ring); }
.navbar, header, .site-header { background:linear-gradient(180deg, var(--surface), var(--bg-alt)); border-bottom:1px solid var(--border);padding:14px 18px;border-radius:12px; margin-bottom:18px; }
footer { background:var(--bg-alt); border-top:1px solid var(--border); padding:16px; border-radius:12px; }
.hero { border-radius:18px; padding:48px 28px; margin: 18px 0; background: linear-gradient(135deg, var(--primary), var(--accent)); color: var(--primary-contrast); }
.hero h1, .hero h2 { color: var(--primary-contrast); }
.tag, .badge { background:var(--bg-alt);border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;font-size:.75rem; }
.kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:var(--bg-alt); border:1px solid var(--border); border-bottom-width:2px; padding:.2rem .4rem; border-radius:6px; }
`;
const THEMES = [
  { name: "Nordic Frost", vars: {"--bg":"#0b1220","--bg-alt":"#0e1628","--surface":"#111b2f","--text":"#e5f0ff","--muted":"#a0b4d0","--primary":"#5aa5ff","--primary-contrast":"#061226","--accent":"#7dd3fc","--accent-contrast":"#071422","--border":"#1e2a44","--ring":"#5aa5ff66","--link":"#93c5fd","--link-hover":"#60a5fa"}, extras:".hero{background:linear-gradient(135deg,#5aa5ff,#7dd3fc);} body{letter-spacing:.01em;}"},
  { name: "Sunset Coral", vars: {"--bg":"#fff7f5","--bg-alt":"#fff1ee","--surface":"#ffffff","--text":"#2b2a2a","--muted":"#7c6f6f","--primary":"#ff6b6b","--primary-contrast":"#ffffff","--accent":"#ffd166","--accent-contrast":"#2b2a2a","--border":"#ffe1dc","--ring":"#ffb3b366","--link":"#ef4444","--link-hover":"#dc2626"}, extras:".hero{background:linear-gradient(135deg,#ff6b6b,#ffd166);} .btn-primary{border-radius:999px;}"},
  { name: "Emerald Pro", vars: {"--bg":"#081511","--bg-alt":"#0c1c17","--surface":"#0f231d","--text":"#dff6ee","--muted":"#96c7b6","--primary":"#10b981","--primary-contrast":"#031a14","--accent":"#34d399","--accent-contrast":"#042317","--border":"#16352b","--ring":"#34d39955","--link":"#6ee7b7","--link-hover":"#34d399"}, extras:".hero{background:linear-gradient(135deg,#10b981,#34d399);}"},
  { name: "Royal Indigo", vars: {"--bg":"#0f1023","--bg-alt":"#141433","--surface":"#1b1c4b","--text":"#e9e9ff","--muted":"#b2b2e8","--primary":"#6366f1","--primary-contrast":"#0b0c2a","--accent":"#a78bfa","--accent-contrast":"#0b0c2a","--border":"#282a66","--ring":"#818cf866","--link":"#a5b4fc","--link-hover":"#818cf8"}, extras:".hero{background:radial-gradient(circle at 20% 10%,#a78bfa,#6366f1);}"},
  { name: "SaaS Light", vars: {"--bg":"#f8fafc","--bg-alt":"#eef2f7","--surface":"#ffffff","--text":"#0f172a","--muted":"#64748b","--primary":"#2563eb","--primary-contrast":"#ffffff","--accent":"#06b6d4","--accent-contrast":"#06252b","--border":"#e2e8f0","--ring":"#93c5fd88","--link":"#2563eb","--link-hover":"#1d4ed8"}, extras:".navbar{backdrop-filter:saturate(1.4) blur(6px);}"},
  { name: "Grape Splash", vars: {"--bg":"#120616","--bg-alt":"#1a0a21","--surface":"#1e0b26","--text":"#f6e8ff","--muted":"#c2a8d6","--primary":"#a855f7","--primary-contrast":"#16022b","--accent":"#f472b6","--accent-contrast":"#2b0a1f","--border":"#2c1a37","--ring":"#c084fc66","--link":"#d8b4fe","--link-hover":"#c084fc"}, extras:".hero{background:linear-gradient(120deg,#a855f7,#f472b6);}"},
  { name: "Carbon Matrix", vars: {"--bg":"#0b0c0e","--bg-alt":"#101214","--surface":"#14171a","--text":"#e5e7eb","--muted":"#9ca3af","--primary":"#22d3ee","--primary-contrast":"#071b1f","--accent":"#38bdf8","--accent-contrast":"#082036","--border":"#1f2327","--ring":"#38bdf866","--link":"#67e8f9","--link-hover":"#22d3ee"}, extras:".card{border-radius:18px;} .hero{background:linear-gradient(135deg,#22d3ee,#38bdf8);}"},
  { name: "Desert Gold", vars: {"--bg":"#0d0904","--bg-alt":"#15100a","--surface":"#1b150e","--text":"#f7e9d0","--muted":"#d6c0a1","--primary":"#f59e0b","--primary-contrast":"#1b150e","--accent":"#fbbf24","--accent-contrast":"#1b150e","--border":"#2a231a","--ring":"#f59e0b66","--link":"#fbbf24","--link-hover":"#f59e0b"}, extras:".hero{background:linear-gradient(135deg,#f59e0b,#fbbf24);}"},
  { name: "Minty Fresh", vars: {"--bg":"#f0fff8","--bg-alt":"#e7fff4","--surface":"#ffffff","--text":"#083b2b","--muted":"#3a7d67","--primary":"#0ea5a5","--primary-contrast":"#f0fff8","--accent":"#2dd4bf","--accent-contrast":"#05332a","--border":"#c8eee3","--ring":"#2dd4bf66","--link":"#0ea5a5","--link-hover":"#0d9488"}, extras:".btn{border-radius:10px;} .hero{background:linear-gradient(135deg,#0ea5a5,#2dd4bf);}"},
  { name: "Crimson Edge", vars: {"--bg":"#0f0a0a","--bg-alt":"#160e0e","--surface":"#1e1111","--text":"#ffe5e5","--muted":"#d8a4a4","--primary":"#ef4444","--primary-contrast":"#1e1111","--accent":"#fb7185","--accent-contrast":"#1e1111","--border":"#2a1414","--ring":"#ef444466","--link":"#fca5a5","--link-hover":"#ef4444"}, extras:".hero{background:linear-gradient(135deg,#ef4444,#fb7185);}"},
  { name: "Aqua Glass", vars: {"--bg":"#031a22","--bg-alt":"#07222b","--surface":"#0b2a35","--text":"#dff7ff","--muted":"#a5cbd6","--primary":"#06b6d4","--primary-contrast":"#031a22","--accent":"#38bdf8","--accent-contrast":"#051c2a","--border":"#133847","--ring":"#38bdf866","--link":"#67e8f9","--link-hover":"#38bdf8"}, extras:".hero{background:linear-gradient(135deg,#06b6d4,#38bdf8);}"},
  { name: "Stone & Sage", vars: {"--bg":"#0e1110","--bg-alt":"#141816","--surface":"#171c1a","--text":"#e7eee9","--muted":"#a3b5ad","--primary":"#22c55e","--primary-contrast":"#0b120e","--accent":"#84cc16","--accent-contrast":"#0b120e","--border":"#233029","--ring":"#22c55e66","--link":"#86efac","--link-hover":"#22c55e"}, extras:".hero{background:linear-gradient(135deg,#22c55e,#84cc16);}"},
  { name: "Rose Quartz", vars: {"--bg":"#fff7fb","--bg-alt":"#ffeef7","--surface":"#ffffff","--text":"#331b2b","--muted":"#7a4d66","--primary":"#e879f9","--primary-contrast":"#2c0f25","--accent":"#fb7185","--accent-contrast":"#2b0a1f","--border":"#f6d7ea","--ring":"#f0abfc66","--link":"#e879f9","--link-hover":"#d946ef"}, extras:".btn-primary{border-radius:999px;} .hero{background:linear-gradient(120deg,#e879f9,#fb7185);}"},
  { name: "Ocean Night", vars: {"--bg":"#030b18","--bg-alt":"#071326","--surface":"#0c1930","--text":"#d8eaff","--muted":"#9bb4d6","--primary":"#2563eb","--primary-contrast":"#030b18","--accent":"#22d3ee","--accent-contrast":"#03141a","--border":"#152545","--ring":"#2563eb66","--link":"#93c5fd","--link-hover":"#60a5fa"}, extras:".hero{background:linear-gradient(135deg,#2563eb,#22d3ee);}"},
  { name: "Lime Pop", vars: {"--bg":"#0f1407","--bg-alt":"#141a0a","--surface":"#181f0d","--text":"#eaffc8","--muted":"#bfd69e","--primary":"#84cc16","--primary-contrast":"#0f1407","--accent":"#a3e635","--accent-contrast":"#0f1407","--border":"#243012","--ring":"#a3e63566","--link":"#d9f99d","--link-hover":"#a3e635"}, extras:".hero{background:linear-gradient(135deg,#84cc16,#a3e635);}"},
  { name: "Slate Minimal", vars: {"--bg":"#0b0d12","--bg-alt":"#0f1218","--surface":"#121722","--text":"#e5e7eb","--muted":"#9ca3af","--primary":"#94a3b8","--primary-contrast":"#0b0d12","--accent":"#22d3ee","--accent-contrast":"#071b1f","--border":"#1f2633","--ring":"#94a3b866","--link":"#cbd5e1","--link-hover":"#94a3b8"}, extras:".btn{border-radius:8px;}"},
  { name: "Tangerine Bold", vars: {"--bg":"#1a0c05","--bg-alt":"#220f06","--surface":"#2a1308","--text":"#ffe8d9","--muted":"#e2b59a","--primary":"#fb923c","--primary-contrast":"#1a0c05","--accent":"#facc15","--accent-contrast":"#1a0c05","--border":"#3a1b0e","--ring":"#fb923c66","--link":"#fed7aa","--link-hover":"#fb923c"}, extras:".hero{background:linear-gradient(135deg,#fb923c,#facc15);}"},
  { name: "Cerulean Studio", vars: {"--bg":"#07121c","--bg-alt":"#0b1a28","--surface":"#0f2135","--text":"#d9ecff","--muted":"#9ec3e0","--primary":"#38bdf8","--primary-contrast":"#07121c","--accent":"#0ea5e9","--accent-contrast":"#06121d","--border":"#173552","--ring":"#38bdf866","--link":"#93c5fd","--link-hover":"#60a5fa"}, extras:".navbar{backdrop-filter: blur(8px) saturate(1.2);}"},
  { name: "Velvet Noir", vars: {"--bg":"#0b0b0b","--bg-alt":"#111111","--surface":"#141414","--text":"#f5f5f5","--muted":"#bdbdbd","--primary":"#bf1650","--primary-contrast":"#14040d","--accent":"#ec4899","--accent-contrast":"#1a0712","--border":"#242424","--ring":"#ec489966","--link":"#f472b6","--link-hover":"#ec4899"}, extras:".hero{background:radial-gradient(1200px 300px at 10% 0%,#bf1650,#111);}"},
  { name: "Ivory & Ink", vars: {"--bg":"#fafaf7","--bg-alt":"#f2f2ec","--surface":"#ffffff","--text":"#1a1a1a","--muted":"#77756f","--primary":"#111111","--primary-contrast":"#ffffff","--accent":"#2563eb","--accent-contrast":"#ffffff","--border":"#e6e3db","--ring":"#11111133","--link":"#111111","--link-hover":"#000000"}, extras:".btn-primary{letter-spacing:.02em;} .hero{background:linear-gradient(180deg,#111,#333);}"},
  { name: "Aurora Neon", vars: {"--bg":"#040810","--bg-alt":"#070d18","--surface":"#0a1020","--text":"#e6fbff","--muted":"#9bd8e6","--primary":"#06d6a0","--primary-contrast":"#031a10","--accent":"#60a5fa","--accent-contrast":"#041225","--border":"#16243d","--ring":"#06d6a066","--link":"#67e8f9","--link-hover":"#06d6a0"}, extras:".hero{background:conic-gradient(from 90deg at 20% 20%, #06d6a0, #60a5fa);}"},
  { name: "Forest Dew", vars: {"--bg":"#0a1310","--bg-alt":"#0f201e","--surface":"#0f201e","--text":"#e6fffb","--muted":"#9ee3d8","--primary":"#10b981","--primary-contrast":"#031a14","--accent":"#34d399","--accent-contrast":"#042317","--border":"#1a2f2c","--ring":"#34d39955","--link":"#6ee7b7","--link-hover":"#34d399"}, extras:".hero{background:linear-gradient(135deg,#10b981,#34d399);}"},
];
function sgwmBuildCSS(theme){ const varLines = Object.entries(theme.vars).map(([k,v])=>`${k}:${v}`).join(';'); return `:root{${varLines}}` + THEME_BASE_CSS + (theme.extras || ""); }

/* ---------- 6) UI render ---------- */
const grid = document.getElementById('sgwm-theme-grid');
THEMES.forEach((t, idx) => {
  const card = document.createElement('div');
  card.className = 'sgwm-theme-card';
  const s1 = t.vars["--primary"] || "#ccc", s2 = t.vars["--accent"]||"#ddd", s3 = t.vars["--bg-alt"]||"#eee";
  card.innerHTML = `<div class="sgwm-swatches"><div class="sgwm-swatch" style="background:${s1}"></div><div class="sgwm-swatch" style="background:${s2}"></div><div class="sgwm-swatch" style="background:${s3}"></div></div><div class="sgwm-theme-name">${idx+1}. ${t.name}</div>`;
  card.addEventListener('click', () => sgwmApplyTheme(t));
  grid.appendChild(card);
});
document.getElementById('sgwm-theme-toggle').addEventListener('click', () => {
  const p = document.getElementById('sgwm-theme-panel');
  p.style.display = (p.style.display === 'block') ? 'none' : 'block';
});

/* ---------- 7) Apply theme (preview + export + repairs) ---------- */
async function sgwmApplyTheme(themeObj){
  const css = sgwmBuildCSS(themeObj);
  window.__SGWM_CURRENT_THEME_CSS = css;

  // Ensure ZIP index
  if (window.ZIP_REF && !SGWM_ZIP_INDEX) await sgwmBuildZipIndex();

  // Live preview
  if (!SGWM_PREVIEW) SGWM_PREVIEW = sgwmFindPreview();
  if (SGWM_PREVIEW) await sgwmApplyThemeToFrame(SGWM_PREVIEW, css);
  else console.warn('[SGWM Theme] preview iframe not found â€” live preview skipped.');

  // Write theme.css into ZIP (for export)
  if (window.ZIP_REF) { window.ZIP_REF.file('theme.css', css); }

  // Repair + link theme.css in editor model (so Export uses fixed/corrected HTML)
  await sgwmRepairAndLinkAll(css);

  sgwmToast('Theme applied. Preview updated â€¢ Export will include theme.css and repaired links.');
}

/* ---------- 8) Live preview: inject CSS & prevent 404s by using blobs ---------- */
async function sgwmApplyThemeToFrame(frame, css){
  const doc = frame.contentDocument || frame.contentWindow?.document;
  if (!doc) return;

  // <style> for immediate visual theme
  let styleEl = doc.getElementById('sgwm-theme-style');
  if (!styleEl) { styleEl = doc.createElement('style'); styleEl.id = 'sgwm-theme-style'; doc.head.appendChild(styleEl); }
  styleEl.textContent = css;

  // Ensure any <link href="theme.css"> points to a blob (no 404)
  const blob = new Blob([css], {type:'text/css'});
  const url  = URL.createObjectURL(blob);

  // Update or add link just for preview
  let linkEl = doc.getElementById('sgwm-theme-link');
  if (!linkEl) { linkEl = doc.createElement('link'); linkEl.id='sgwm-theme-link'; linkEl.rel='stylesheet'; doc.head.appendChild(linkEl); }
  linkEl.href = url;

  // REPAIR known-bad asset refs inside the iframe (styles.css/scripts.js mismatches etc.)
  if (window.ZIP_REF) {
    await sgwmBuildZipIndex();
    const nodes = [...doc.querySelectorAll('link[rel="stylesheet"][href], script[src]')];
    for (const n of nodes) {
      const attr = n.tagName.toLowerCase()==='link' ? 'href' : 'src';
      const href = n.getAttribute(attr);
      if (!href || href.startsWith('blob:') || href.startsWith('data:')) continue;
      // Skip absolute URLs (CDNs)
      try { const u = new URL(href, location.origin); if (u.origin !== location.origin) continue; } catch {}

      const guess = sgwmGuessFileFromIndex(href);
      if (guess) {
        // Load from ZIP and convert to blob URL
        const file = window.ZIP_REF.file(guess);
        if (file) {
          try {
            const blob = await file.async('blob');
            const url = URL.createObjectURL(blob);
            n.setAttribute(attr, url);
            n.setAttribute('data-sgwm-fixed','1');
          } catch(e){}
        }
      }
    }
  }
}

/* ---------- 9) Repair + link theme.css across ALL pages in model ---------- */
async function sgwmRepairAndLinkAll(themeCss){
  const pages = SGWM_MODEL.pages.slice();
  if (window.ZIP_REF && !SGWM_ZIP_INDEX) await sgwmBuildZipIndex();

  for (const path of pages) {
    if (!/\.html?$/i.test(path)) continue;
    let html = SGWM_MODEL.raw(path);
    if (!html) continue;

    // Repair broken styles/scripts references inside HTML based on ZIP index
    html = await sgwmRepairHtmlAssetRefs(html);

    // Link theme.css (relative)
    const relHref = sgwmRelativeToRoot(path, 'theme.css');
    if (!/theme\.css/i.test(html)) html = sgwmInsertThemeLink(html, relHref);
    else html = sgwmNormalizeExistingThemeLink(html, relHref);

    SGWM_MODEL.setEdited(path, html);
  }
}

/* ----- Asset repair helpers ----- */
async function sgwmRepairHtmlAssetRefs(html){
  if (!SGWM_ZIP_INDEX) return html;

  // Replace in <link rel="stylesheet">
  html = html.replace(/<link([^>]*?)rel=(['"])stylesheet\2([^>]*?)href=(['"])([^'"]+)\4([^>]*)>/ig,
    (m, pre, q1, mid, q2, href, post) => {
      const fixed = sgwmGuessFileFromIndex(href);
      if (fixed) return `<link${pre}rel=${q1}stylesheet${q1}${mid}href=${q2}${fixed}${q2}${post}>`;
      // try simple plural/singular fix if no ZIP match (common case for external uploads)
      if (/\/?styles\.css$/i.test(href)) return m.replace(/styles\.css/i,'style.css');
      if (/\/?scripts\.js$/i.test(href)) return m.replace(/scripts\.js/i,'script.js');
      return m;
    });

  // Replace in <script src="...">
  html = html.replace(/<script([^>]*?)src=(['"])([^'"]+)\2([^>]*)>\s*<\/script>/ig,
    (m, pre, q, src, post) => {
      const fixed = sgwmGuessFileFromIndex(src);
      if (fixed) return `<script${pre}src=${q}${fixed}${q}${post}></script>`;
      if (/\/?scripts\.js$/i.test(src)) return m.replace(/scripts\.js/i,'script.js');
      return m;
    });

  return html;
}

/* ----- HTML link injection helpers ----- */
function sgwmInsertThemeLink(html, relHref){
  const tag = `<link rel="stylesheet" href="${relHref}?v=${Date.now()}">`;
  if (/<\/head>/i.test(html)) return html.replace(/<\/head>/i, `${tag}\n</head>`);
  return `${tag}\n${html}`; // fallback if <head> missing
}
function sgwmNormalizeExistingThemeLink(html, relHref){
  return html.replace(
    /<link([^>]*?)href=(['"])([^'"]*theme\.css[^'"]*)\2([^>]*)>/ig,
    (_m, pre, q, _old, post) => `<link${pre}href=${q}${relHref}?v=${Date.now()}${q}${post}>`
  );
}
function sgwmRelativeToRoot(pagePath, fileAtRoot){
  if (!pagePath.includes('/')) return fileAtRoot;
  const depth = pagePath.split('/').length - 1;
  const up = Array(depth).fill('..').join('/');
  return `${up}/${fileAtRoot}`;
}

/* ---------- 10) Build the picker UI ---------- */
(function buildPicker(){
  const grid = document.getElementById('sgwm-theme-grid');
  if (!grid) return;
  // cards are already appended above â€” this IIFE is kept if you want to add filters later
})();
</script>
<!-- ======================= SGWM THEME ENGINE (ROBUST) â€” END ======================= -->

</body>
</html>
