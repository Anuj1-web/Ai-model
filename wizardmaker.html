<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wizard Maker — Button Fix (v11 UI + Placeholder)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
    }
    .card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      max-width: 1100px;
      width: 100%;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: .25rem;
    }
    p {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }
    .topbar {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    input[type="file"] {
      padding: .4rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
    }
    button {
      padding: .5rem .9rem;
      border: none;
      border-radius: .5rem;
      background: #111; /* BLACK EXPORT BUTTON */
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover {
      background: #333;
    }
    .tabs {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
    .tab {
      padding: .25rem .75rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      background: #f3f4f6;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .tab.active {
      background: #e5e7eb;
      font-weight: bold;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: .5rem;
      background: #fff;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .modal h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    .mb-2 { margin-bottom: .5rem; }
    .mb-3 { margin-bottom: .75rem; }
    .mb-4 { margin-bottom: 1rem; }
    input, select {
      padding: .5rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      width: 100%;
      font-size: .9rem;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
    }
    .actions button {
      flex: 0 0 auto;
    }
    #cancelBtn {
      background: #e5e7eb;
      color: #111;
    }
    #cancelBtn:hover {
      background: #d1d5db;
    }
 /* Wizard Maker Library Sidebar */
#librarySidebar {
  position: fixed;
  right: 0;
  top: 0;
  height: 100vh;
  width: 280px;
  background: #f9fafb;
  border-left: 1px solid #ccc;
  padding: 1rem;
  overflow-y: auto;
  box-shadow: -4px 0 12px rgba(0,0,0,0.05);
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  font-size: 0.85rem;
}

#librarySidebar h3 {
  margin: 0 0 0.5rem 0;
  font-size: 0.95rem;
  font-weight: bold;
}

.library-category {
  margin-bottom: 1rem;
}

.library-item {
  padding: 0.35rem 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.4rem;
  margin-bottom: 0.35rem;
  cursor: grab;
  background: #fff;
}

.library-item:hover {
  background: #e5e7eb;
}

.library-item.dragging {
  opacity: 0.6;
}

#pageNavContainer {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.5rem;
  background: rgba(255,255,255,0.95);
  padding: 0.5rem 1rem;
  border-radius: 0.5rem 0.5rem 0 0;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  z-index: 90;
}

#pageNavContainer button {
  padding: 0.4rem 0.7rem;
  border-radius: 0.4rem;
  border: 1px solid #ccc;
  background: #f3f4f6;
  cursor: pointer;
  font-size: 0.85rem;
}

#pageNavContainer button.active {
  font-weight: bold;
  background: #e5e7eb;
}
  </style>
</head>
<body>
  <div class="card">
    <h1>Wizard Maker — Button Fix (v11)</h1>
    <p>Upload EduPro (multi-page). Double-click or double-tap buttons/links/inputs to edit. Cancel fully restores. Fonts untouched.</p>

    <div class="topbar">
      <input type="file" id="zipInput" accept=".zip">
      <button id="exportBtn">⬇ Export ZIP</button>
    </div>

    <div class="tabs" id="tabs"></div>
    <div id="iframeContainer"></div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h2>Edit Element</h2>
      <div id="textSection" class="mb-4">
        <label class="mb-2">Text / Placeholder</label>
        <input id="modalText">
      </div>
      <div class="mb-3">
        <label class="mb-2">Color Mode</label>
        <select id="colorTarget">
          <option value="auto">Auto</option>
          <option value="text">Text Color</option>
          <option value="background">Background</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="mb-2">Color Picker</label>
        <input type="color" id="modalColor" style="width:70px;">
      </div>
      <div class="mb-4">
        <label class="mb-2">Replace Image</label>
        <input type="url" id="imageUrl" placeholder="Image URL">
        <input type="file" id="imageFile" accept="image/*">
      </div>
      <div class="actions">
        <button id="cancelBtn">Cancel</button>
        <button id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const zipInput = document.getElementById("zipInput");
    const exportBtn = document.getElementById("exportBtn");
    const tabsEl = document.getElementById("tabs");
    const iframeContainer = document.getElementById("iframeContainer");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalText = document.getElementById("modalText");
    const modalColor = document.getElementById("modalColor");
    const colorTargetSel = document.getElementById("colorTarget");
    const imageUrl = document.getElementById("imageUrl");
    const imageFile = document.getElementById("imageFile");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    let pages = [];
    let pageContents = {};
    let editedContents = {};
    let otherFiles = {};
    let activePage = "";
    let iframeRefs = {};

    let modalTarget = { page: "", id: "", hasText: false, hasPlaceholder: false };
    let originalSnapshot = null;

    // --- File handling ---
    zipInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const zip = await JSZip.loadAsync(file);
      const newPages = [];
      const newContents = {};
      const other = {};

      await Promise.all(Object.keys(zip.files).map(async (filename) => {
        const entry = zip.files[filename];
        if (entry.dir) return;
        if (filename.toLowerCase().endsWith(".html")) {
          const data = await entry.async("string");
          newPages.push(filename);
          newContents[filename] = data;
        } else {
          const data = await entry.async("uint8array");
          other[filename] = data;
        }
      }));

      newPages.sort((a,b) => {
        const ai = /(^|\/)index\.html$/i.test(a);
        const bi = /(^|\/)index\.html$/i.test(b);
        if (ai && !bi) return -1;
        if (!ai && bi) return 1;
        return a.localeCompare(b);
      });

      pages = newPages;
      pageContents = newContents;
      editedContents = {...newContents};
      otherFiles = other;
      activePage = newPages[0] || "";

      renderTabs();
      renderIframes();
    });

    function renderTabs() {
      tabsEl.innerHTML = "";
      pages.forEach((p) => {
        const tab = document.createElement("div");
        tab.className = "tab" + (p === activePage ? " active" : "");
        tab.textContent = p;
        tab.onclick = () => { activePage = p; renderTabs(); renderIframes(); };
        tabsEl.appendChild(tab);
      });
    }

    function injectEditingBridge(html, pageName) {
      const bridge = `<script>(function(){
        var EDIT_ATTR='data-edit-id';
        var clickTimers={};
        function ensureId(el){if(!el.getAttribute(EDIT_ATTR)) el.setAttribute(EDIT_ATTR,'e'+Math.random().toString(36).slice(2,9));return el.getAttribute(EDIT_ATTR);}
        function buildSnapshot(el){return {
          html: el.innerHTML || '',
          text: el.innerText || '',
          placeholder: ('placeholder' in el ? el.placeholder || undefined : undefined),
          src: (el.tagName==='IMG'?(el.getAttribute('src')||el.src||''):undefined),
          inline:{color:el.style.color,backgroundColor:el.style.backgroundColor}
        };}
        document.addEventListener('click',function(e){
          var el=e.target;if(!el)return;
          var tn=(el.tagName||'').toUpperCase();
          if(tn==='A'||tn==='BUTTON'||tn==='INPUT'||tn==='TEXTAREA'){
            var id=ensureId(el);
            e.preventDefault();e.stopPropagation();
            if(clickTimers[id]){
              clearTimeout(clickTimers[id]);clickTimers[id]=null;
              var snap=buildSnapshot(el);
              parent.postMessage({type:'OPEN_EDITOR',page:'${pageName}',id:id,
                hasText:!!el.innerText,
                hasPlaceholder:('placeholder' in el),
                ...snap},'*');
            }else{
              clickTimers[id]=setTimeout(function(){
                clickTimers[id]=null;
                var href=(el.tagName==='A'&&el.href)?el.href:null;
                if(href) window.location.href=href; else el.click();
              },300);
            }
          }
        },true);
        document.addEventListener('dblclick',function(e){
          var el=e.target;if(!el)return;
          e.preventDefault();e.stopPropagation();
          var id=ensureId(el);
          var snap=buildSnapshot(el);
          parent.postMessage({type:'OPEN_EDITOR',page:'${pageName}',id:id,
            hasText:!!el.innerText,
            hasPlaceholder:('placeholder' in el),
            ...snap},'*');
        },true);
        window.addEventListener('message',function(ev){
          var d=ev.data||{};
          var el=document.querySelector('['+EDIT_ATTR+'="'+d.id+'"]');
          if(!el)return;
          if(d.type==='APPLY_TEXT'){
            if('placeholder' in el) el.placeholder=d.text||''; else el.innerText=d.text||'';
          }
          if(d.type==='APPLY_COLOR'){if(d.target==='background')el.style.backgroundColor=d.color;else el.style.color=d.color;}
          if(d.type==='APPLY_IMAGE'&&el.tagName==='IMG')el.src=d.src;
          if(d.type==='RESTORE_ELEMENT'&&d.snapshot){
            if(d.snapshot.html!==undefined && !('placeholder' in el)) el.innerHTML=d.snapshot.html;
            if(d.snapshot.placeholder!==undefined && 'placeholder' in el) el.placeholder=d.snapshot.placeholder;
            if(d.snapshot.src!==undefined&&el.tagName==='IMG')el.src=d.snapshot.src;
            if(d.snapshot.inline){el.style.color=d.snapshot.inline.color||'';el.style.backgroundColor=d.snapshot.inline.backgroundColor||'';}
          }
        });
      })();<\/script>`;
      return html.replace(/<\/body>/i, bridge + "</body>");
    }

    function renderIframes() {
      iframeContainer.innerHTML = "";
      if (!activePage) return;
      const iframe = document.createElement("iframe");
      iframe.srcdoc = injectEditingBridge(editedContents[activePage] || pageContents[activePage] || "", activePage);
      iframeContainer.appendChild(iframe);
      iframeRefs[activePage] = iframe;
    }

    window.addEventListener("message", (event) => {
      const d = event.data || {};
      if (d.type === "OPEN_EDITOR") {
        modalTarget = { page: d.page, id: d.id, hasText: !!d.hasText, hasPlaceholder: !!d.hasPlaceholder };
        modalText.value = d.hasPlaceholder ? d.placeholder || "" : (d.text || "");
        modalColor.value = "#000000";
        originalSnapshot = d;
        modalBackdrop.style.display = "flex";
        document.getElementById("textSection").style.display = (d.hasText || d.hasPlaceholder) ? "block" : "none";
      }
    });

    modalText.addEventListener("input", () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_TEXT",id,text:modalText.value},"*");
    });

    modalColor.addEventListener("input", () => {
      const {page,id,hasText} = modalTarget;
      const target = colorTargetSel.value==="auto" ? (hasText ? "color" : "background") : colorTargetSel.value;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_COLOR",id,color:modalColor.value,target},"*");
    });

    imageUrl.addEventListener("input", () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:imageUrl.value},"*");
    });

    imageFile.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const {page,id} = modalTarget;
        iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:reader.result},"*");
      };
      reader.readAsDataURL(file);
    });

    saveBtn.onclick = () => {
      const {page} = modalTarget;
      const iframe = iframeRefs[page];
      if (iframe.contentDocument) {
        const html = "<!DOCTYPE html>" + iframe.contentDocument.documentElement.outerHTML;
        editedContents[page] = html;
      }
      modalBackdrop.style.display = "none";
    };

    cancelBtn.onclick = () => {
      const {page,id} = modalTarget;
      const iframe = iframeRefs[page];
      if (iframe?.contentWindow && originalSnapshot) {
        iframe.contentWindow.postMessage({type:"RESTORE_ELEMENT",id,snapshot:originalSnapshot},"*");
      }
      modalBackdrop.style.display = "none";
    };

    exportBtn.addEventListener("click", async () => {
      const zip = new JSZip();
      pages.forEach((filename) => {
        const html = editedContents[filename] || pageContents[filename] || "";
        zip.file(filename, html);
      });
      Object.entries(otherFiles).forEach(([filename, data]) => {
        zip.file(filename, data);
      });
      const blob = await zip.generateAsync({type:"blob"});
      saveAs(blob, "custom-site.zip");
    });
  </script>
<script>
  function autoLoadTemplate() {
    const templateData = localStorage.getItem("wizardTemplate");
    if (!templateData) return;

    try {
      // Decode base64 zip string back into a Blob
      const binary = atob(templateData.split(',')[1]);
      const array = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        array[i] = binary.charCodeAt(i);
      }
      const blob = new Blob([array], { type: "application/zip" });
      const file = new File([blob], "template.zip", { type: "application/zip" });

      // Feed the file into zipInput
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      const zipInput = document.getElementById("zipInput");
      zipInput.files = dataTransfer.files;

      // Trigger the change event to load into editor
      zipInput.dispatchEvent(new Event("change", { bubbles: true }));

      // Clear storage so it doesn’t auto-load next time accidentally
      localStorage.removeItem("wizardTemplate");
    } catch (err) {
      console.error("Template auto-load failed:", err);
    }
  }
   autoLoadTemplate();
</script>  <!-- ✅ properly close the previous script -->

<!-- ================== LIBRARY SIDEBAR FETCH FROM LIBRARY ================== -->

<!-- Floating black + button -->
<button id="openLibraryBtn" style="
  position: fixed; bottom: 20px; right: 20px;
  width: 50px; height: 50px; border-radius: 50%;
  background: #111; color: #fff; font-size: 2rem;
  border: none; cursor: pointer; z-index: 2000;">+</button>

<!-- Sidebar -->
<div id="librarySidebar" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
    <h3 style="margin:0;color:#fff;">Library Assets</h3>
    <button id="closeLibraryBtn" style="background:none;color:#fff;font-size:1.2rem;border:none;cursor:pointer;">✖</button>
  </div>

  <!-- Search -->
  <input type="text" id="librarySearch" placeholder="Search..."
         style="width:100%;padding:0.3rem;margin-bottom:0.5rem;border-radius:0.25rem;border:none;background:#333;color:#fff;">

  <!-- Container -->
  <div id="libraryContainer" style="overflow-y:auto; flex:1;"></div>

  <hr style="border-color:#444;margin:0.5rem 0;">

  <button id="addPageBtnSidebar"
          style="padding:0.4rem;background:#222;color:#fff;border:none;border-radius:0.25rem;cursor:pointer;">
    + Add Blank Page
  </button>
</div>

<style>
#librarySidebar {
  position: fixed;
  top: 0; right: 0;
  width: 320px; height: 100vh;
  background: #111; padding: 1rem;
  box-shadow: -4px 0 12px rgba(0,0,0,0.5);
  z-index: 1500;
  color: #fff;
  display: flex;
  flex-direction: column;
}
.library-category {
  font-weight: bold;
  margin-top: 1rem;
  color: #fff;
}
.library-subcategory {
  font-style: italic;
  font-size: 0.85rem;
  margin-bottom: 0.2rem;
  color: #ccc;
}
.library-item {
  padding: 0.5rem;
  margin-bottom: 0.6rem;
  border-radius: 0.3rem;
  background: #222;
  cursor: pointer;
  color: #fff;
  text-align: center;
}
.library-item:hover { background: #333; }
.library-thumb { max-height: 80px; overflow:hidden; margin-bottom:0.3rem; }
.library-thumb img { max-width: 100%; border-radius:4px; }
.library-title { font-size:0.8rem; color:#ddd; }
</style>

<script>
// ===== Fetch assets from localStorage.sitegenLibrary =====
function getLibraryData(){
  try {
    return JSON.parse(localStorage.getItem("sitegenLibrary") || "[]");
  } catch { return []; }
}

let allAssets = getLibraryData();
// Filter out templates
allAssets = allAssets.filter(item => item.type !== "template");

// Render Sidebar
function renderLibraryAssets(filter=""){
  const container=document.getElementById('libraryContainer');
  container.innerHTML='';

  // Group by type + subcategory
  const categories={};
  allAssets.forEach(item=>{
    const cat=item.type; // asset/page/theme/subscription
    const sub=item.subcategory || "General";
    if(!categories[cat]) categories[cat]={};
    if(!categories[cat][sub]) categories[cat][sub]=[];
    categories[cat][sub].push(item);
  });

  Object.keys(categories).forEach(cat=>{
    const catDiv=document.createElement('div');
    catDiv.className='library-category';
    catDiv.textContent=cat.charAt(0).toUpperCase()+cat.slice(1);
    container.appendChild(catDiv);

    Object.keys(categories[cat]).forEach(sub=>{
      const subDiv=document.createElement('div');
      subDiv.className='library-subcategory';
      subDiv.textContent=sub.charAt(0).toUpperCase()+sub.slice(1);
      container.appendChild(subDiv);

      categories[cat][sub].forEach(item=>{
        if(filter && !item.name.toLowerCase().includes(filter.toLowerCase())) return;

        const div=document.createElement('div');
        div.className='library-item';

        const thumb=document.createElement('div');
        thumb.className='library-thumb';
        if(item.thumbnail){
          const img=document.createElement('img');
          img.src=item.thumbnail;
          thumb.appendChild(img);
        } else {
          const preview=document.createElement('div');
          preview.innerHTML=item.content || "";
          preview.style.transform="scale(0.4)";
          preview.style.transformOrigin="top left";
          preview.style.height="80px";
          preview.style.overflow="hidden";
          thumb.appendChild(preview);
        }

        const title=document.createElement('div');
        title.className='library-title';
        title.innerText=item.name.replace(/[_-]/g," ");

        div.appendChild(thumb);
        div.appendChild(title);

        if(item.type==="page"){
          // full page
          div.addEventListener("click",()=>{
            const filename=item.name.toLowerCase().replace(/\s+/g,'_')+".html";
            pages.push(filename);
            pageContents[filename]=item.content;
            editedContents[filename]=item.content;
            activePage=filename;
            renderTabs();
            renderIframes();
          });
        } else {
          // insert element
          div.addEventListener("click",()=>{
            const iframe=iframeRefs[activePage];
            if(!iframe) return;
            const doc=iframe.contentDocument||iframe.contentWindow.document;
            let insertTarget = doc.activeElement && doc.body.contains(doc.activeElement) ? doc.activeElement : doc.body;
            const temp=document.createElement('div');
            temp.innerHTML=item.content;
            insertTarget.appendChild(temp.firstChild);
            editedContents[activePage]="<!DOCTYPE html>"+doc.documentElement.outerHTML;
          });
          // Drag/drop
          div.draggable=true;
          div.addEventListener('dragstart', e=>{
            e.dataTransfer.setData('text/html', item.content);
            div.classList.add('dragging');
          });
          div.addEventListener('dragend', ()=>div.classList.remove('dragging'));
        }

        container.appendChild(div);
      });
    });
  });
}

// Search
document.getElementById("librarySearch").addEventListener("input",e=>{
  renderLibraryAssets(e.target.value);
});

// Open/close
document.getElementById('openLibraryBtn').onclick=()=>{document.getElementById('librarySidebar').style.display='flex';};
document.getElementById('closeLibraryBtn').onclick=()=>{document.getElementById('librarySidebar').style.display='none';};

// Enable drop inside iframe
function enableDrop(){
  const iframe=iframeRefs[activePage];
  if(!iframe) return;
  const doc=iframe.contentDocument||iframe.contentWindow.document;
  doc.body.addEventListener("dragover", e=>e.preventDefault());
  doc.body.addEventListener("drop", e=>{
    e.preventDefault();
    const html=e.dataTransfer.getData("text/html");
    if(html){
      const temp=document.createElement("div");
      temp.innerHTML=html;
      doc.body.appendChild(temp.firstChild);
      editedContents[activePage]="<!DOCTYPE html>"+doc.documentElement.outerHTML;
    }
  });
}
const originalRenderIframes=renderIframes;
renderIframes=function(){ originalRenderIframes(); enableDrop(); };

// Blank page
document.getElementById('addPageBtnSidebar').onclick=()=>{
  const name=prompt('Enter new page name:');
  if(!name) return;
  const filename=name.replace(/\s+/g,'_').toLowerCase()+'.html';
  const html=`<!DOCTYPE html><html><head><title>${name}</title></head><body><h1>${name}</h1></body></html>`;
  pages.push(filename);
  pageContents[filename]=html;
  editedContents[filename]=html;
  activePage=filename;
  renderTabs();
  renderIframes();
};

// Initial render
renderLibraryAssets();
</script>
<!--
Universal Theme Engine (SGWM Pro)
Version: 1.0.0
Single-file drop-in script + UI panel (Shadow DOM isolated)
Paste this whole block right before </body> in WizardMaker (or any builder preview page).
It auto-detects site structure (nav/hero/cards/sections/buttons/forms/tables/footer/etc),
provides 24+ professional themes, ensures WCAG contrast, and supports per-section mapping.

Notes:
- The UI is fully sandboxed in a Shadow DOM so it won't break host CSS.
- The theming CSS is injected to the detected preview document using a single <style id="sgwm-theme-override-pro"> tag.
- Everything runs in an IIFE to avoid globals (one global namespace only: window.SGWM_PRO_THEME for state/export).
- If your builder uses an iframe preview, the engine finds the largest visible iframe automatically.
-->

<style id="sgwm-pro-initial" media="all">
  /* Only minimal CSS to show the floating button host; panel CSS lives in Shadow DOM */
  :root { --sgwm-pro-z: 2147480000; }
  #sgwm-pro-host { all: initial; position: fixed; right: 20px; bottom: 70px; z-index: var(--sgwm-pro-z); }
</style>

<div id="sgwm-pro-host" aria-live="polite"></div>

<script>
(function(){
  // ========================= Utilities =========================
  const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
  const toHex = (n) => Math.round(clamp(n,0,255)).toString(16).padStart(2,'0');
  const isDef = (v)=> v!==undefined && v!==null && v!=='';

  function parseColor(input){ if(!input) return null; const s=String(input).trim().toLowerCase(); let m;
    if((m=s.match(/^#([0-9a-f]{3,8})$/i))){ let h=m[1]; if(h.length===3) h=h.split('').map(ch=>ch+ch).join('');
      const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16); return {r,g,b}; }
    if((m=s.match(/^rgba?\(([^)]+)\)$/i))){ const [r,g,b]=m[1].split(',').map(v=>parseFloat(v)); return {r,g,b}; }
    if((m=s.match(/^hsla?\(([^)]+)\)$/i))){ const [H,S,L]=m[1].split(',').map(v=>v.trim()); return hslToRgb({h:parseFloat(H), s:parseFloat(S)/100, l:parseFloat(L)/100}); }
    return null; }
  function rgbToHex({r,g,b}){ return `#${toHex(r)}${toHex(g)}${toHex(b)}`; }
  function rgbToHsl({r,g,b}){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2;
    if(max===min){ h=s=0; } else { const d=max-min; s = l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){ case r: h=(g-b)/d+(g<b?6:0); break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break; } h/=6; }
    return {h:h*360, s, l}; }
  function hslToRgb({h,s,l}){ h=((h%360)+360)%360; const C=(1-Math.abs(2*l-1))*s, X=C*(1-Math.abs(((h/60)%2)-1)), m=l-C/2; let r1=0,g1=0,b1=0;
    if(h<60) [r1,g1,b1]=[C,X,0]; else if(h<120) [r1,g1,b1]=[X,C,0]; else if(h<180) [r1,g1,b1]=[0,C,X]; else if(h<240) [r1,g1,b1]=[0,X,C]; else if(h<300) [r1,g1,b1]=[X,0,C]; else [r1,g1,b1]=[C,0,X];
    return { r:(r1+m)*255, g:(g1+m)*255, b:(b1+m)*255 }; }
  const hex = (v)=>{ const c=parseColor(v); return c?rgbToHex(c).toLowerCase():null; };

  // Contrast helpers
  const luminance = (c)=>{ const a=[c.r,c.g,c.b].map(v=>{ v/=255; return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4); }); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2]; };
  const contrastRatio = (a,b)=>{ const la=luminance(a)+0.05, lb=luminance(b)+0.05; return la>lb?la/lb:lb/la; };
  function ensureReadableTextColor(bgHex, preferredText){
    const bg = parseColor(bgHex)||{r:255,g:255,b:255};
    const black = {r:17,g:17,b:17}, white={r:255,g:255,b:255};
    const pref = parseColor(preferredText||'#111')||black;
    const best = [pref, black, white].map(c=>({c, cr:contrastRatio(c,bg)})).sort((a,b)=>b.cr-a.cr)[0].c;
    return rgbToHex(best);
  }
  function lighten(h,a=0.08){ try{ const base=parseColor(h)||{r:0,g:0,b:0}; const t=rgbToHsl(base); t.l=clamp(t.l+a,0,1); return rgbToHex(hslToRgb(t)); }catch(e){return h} }
  function darken(h,a=0.08){ try{ const base=parseColor(h)||{r:0,g:0,b:0}; const t=rgbToHsl(base); t.l=clamp(t.l-a,0,1); return rgbToHex(hslToRgb(t)); }catch(e){return h} }

  // ========================= Target Document Discovery =========================
  function findPreviewFrame(){
    const hints=['#site-preview','#wizardPreview','#preview','#editor-preview','iframe[title*="Preview" i]'];
    for(const sel of hints){ const el=document.querySelector(sel); if(el && el.tagName==='IFRAME') return el; }
    const iframes=[...document.querySelectorAll('iframe')].filter(f=>{ try{ const r=f.getBoundingClientRect(); return r.width*r.height>30000 && r.top<window.innerHeight; }catch{ return false; } }).sort((a,b)=>(b.clientWidth*b.clientHeight)-(a.clientWidth*a.clientHeight));
    return iframes[0]||null;
  }
  function getPreviewDocument(){ const f=findPreviewFrame(); try{ return f?(f.contentDocument||f.contentWindow?.document):document; }catch{ return null; } }

  // ========================= Structure Detection Engine =========================
  // Heuristic selector pools (extend/override at runtime if needed)
  const POOL = {
    nav: ['nav','.navbar','.nav-bar','.site-nav','.topbar','.top-bar','[role="navigation"]','header .nav','header .menu','.menu-primary','.main-menu','.header-nav'],
    header: ['header','.site-header','.appbar','.masthead','.global-header'],
    hero: ['.hero','.hero-section','.jumbotron','.page-hero','header .hero','.banner','.page-banner','.masthead-hero'],
    footer: ['footer','.site-footer','.page-footer','[role="contentinfo"]','.footbar'],
    section: ['section','.section','.content-section','.block','.feature','.features','.module','.panel','.container .section'],
    card: ['.card','.panel','.tile','.box','.well','.portlet','.card-body','.card-inner','.feature-card','.service-card'],
    text: ['h1','h2','h3','h4','h5','h6','p','.lead','.text','.content','.copy'],
    button: ['button','.btn','a.button','a.btn','[role="button"]','input[type="button"]','input[type="submit"]','.badge','.chip','.tag','.cta'],
    form: ['form','.form','.form-group','input','textarea','select','label','.input','.form-control'],
    table: ['table','.table','thead','tbody','tfoot','th','td'],
    alert: ['.alert','.notice','.callout','.toast','.message','.notification'],
  };

  function rankElements(doc, selectors){
    const out = new Set();
    const push = (el)=>{ if(el && el instanceof doc.defaultView.HTMLElement) out.add(el); };
    for(const sel of selectors){ try{ doc.querySelectorAll(sel).forEach(push); }catch{} }
    // Heuristics: keep only visible & sizable
    return [...out].filter(el=>{
      const r=el.getBoundingClientRect();
      const isVisible = r.width>1 && r.height>1 && getComputedStyle(el).visibility!=='hidden';
      return isVisible;
    });
  }

  function detectStructure(doc){
    const map = {};
    for(const key of Object.keys(POOL)){
      map[key] = rankElements(doc, POOL[key]);
    }
    // Fallbacks: if no hero but large header with background-image → use it
    if(map.hero.length===0){
      const heads = rankElements(doc, POOL.header);
      const big = heads.find(h=>{
        const r=h.getBoundingClientRect();
        const bg=getComputedStyle(h).backgroundImage;
        return r.height>240 || (bg && bg!=='none');
      });
      if(big) map.hero=[big];
    }
    return map;
  }

  // ========================= Theme Presets (24+) =========================
  const THEMES = [
    { id:'ocean-breeze', name:'Ocean Breeze', palette:(b)=>({ primary:'#0ea5e9', secondary:'#38bdf8', accent:'#06b6d4', bg:'#f0f9ff', surface:'#e0f2fe', text:'#0f172a', muted:'#94a3b8', hero:'#e6f6ff', footer:'#062b3a', card:'#ffffff', block:'#f8fdff' }) },
    { id:'modern-indigo', name:'Modern Indigo', palette:(b)=>({ primary:'#4f46e5', secondary:'#6366f1', accent:'#a78bfa', bg:'#f8fafc', surface:'#eef2ff', text:'#0f172a', muted:'#c7c9ff', hero:'#eef2ff', footer:'#0b1020', card:'#ffffff', block:'#f4f6ff' }) },
    { id:'clean-corporate', name:'Clean Corporate', palette:(b)=>({ primary:'#0052cc', secondary:'#2684ff', accent:'#36b37e', bg:'#f9fafc', surface:'#ffffff', text:'#172b4d', muted:'#dfe1e6', hero:'#ebf2ff', footer:'#091e42', card:'#ffffff', block:'#f4f5f7' }) },
    { id:'forest-mist', name:'Forest Mist', palette:(b)=>({ primary:'#166534', secondary:'#4ade80', accent:'#22c55e', bg:'#f0fdf4', surface:'#ecfdf5', text:'#064e3b', muted:'#bbf7d0', hero:'#ddfbe8', footer:'#052e16', card:'#ffffff', block:'#eefbf2' }) },
    { id:'space-nebula', name:'Space Nebula', palette:(b)=>({ primary:'#7c3aed', secondary:'#2563eb', accent:'#f472b6', bg:'#0f172a', surface:'#111827', text:'#f1f5f9', muted:'#94a3b8', hero:'#312e81', footer:'#0b1020', card:'#0f172a', block:'#1f2937' }) },
    { id:'luxury-black-gold', name:'Luxury Black & Gold', palette:(b)=>({ primary:'#d4af37', secondary:'#b8860b', accent:'#ffcc00', bg:'#0a0a0a', surface:'#111111', text:'#f8f5ef', muted:'#666666', hero:'#151515', footer:'#000000', card:'#121212', block:'#101010' }) },
    { id:'pastel-dream', name:'Pastel Dream', palette:(b)=>({ primary:'#a78bfa', secondary:'#f9a8d4', accent:'#6ee7b7', bg:'#faf5ff', surface:'#fce7f3', text:'#374151', muted:'#e9d5ff', hero:'#fdf4ff', footer:'#a78bfa', card:'#fce7f3', block:'#ede9fe' }) },
    { id:'warm-coffee', name:'Warm Coffee', palette:(b)=>({ primary:'#6b4226', secondary:'#d6a36c', accent:'#a16207', bg:'#fefae0', surface:'#faedcd', text:'#3b2f2f', muted:'#d6ccc2', hero:'#fef3d4', footer:'#4a342e', card:'#faedcd', block:'#f1e6d9' }) },
    { id:'retro-vintage', name:'Retro Vintage', palette:(b)=>({ primary:'#b45309', secondary:'#f59e0b', accent:'#78350f', bg:'#fffbeb', surface:'#fff7ed', text:'#3b2f2f', muted:'#d6d3d1', hero:'#fff8e6', footer:'#5a2d08', card:'#fff7ed', block:'#fff6e8' }) },
    { id:'cyberpunk', name:'Cyberpunk', palette:(b)=>({ primary:'#ff00cc', secondary:'#00ffff', accent:'#ff8a00', bg:'#0b0b12', surface:'#12121a', text:'#e6e6e6', muted:'#707070', hero:'#151525', footer:'#000000', card:'#12121a', block:'#0f0f14' }) },
    { id:'minimal-white', name:'Minimal White', palette:(b)=>({ primary:'#111827', secondary:'#4b5563', accent:'#2563eb', bg:'#ffffff', surface:'#f8fafc', text:'#111827', muted:'#e5e7eb', hero:'#f1f5f9', footer:'#e5e7eb', card:'#ffffff', block:'#f9fafb' }) },
    { id:'sunset-glow', name:'Sunset Glow', palette:(b)=>({ primary:'#f97316', secondary:'#fb923c', accent:'#f59e0b', bg:'#fff7ed', surface:'#ffedd5', text:'#431407', muted:'#fed7aa', hero:'#ffedd5', footer:'#7c2d12', card:'#fff7ed', block:'#fff3ea' }) },
    { id:'royal-elegance', name:'Royal Elegance', palette:(b)=>({ primary:'#6d28d9', secondary:'#8b5cf6', accent:'#f472b6', bg:'#f5f3ff', surface:'#ede9fe', text:'#1e1b4b', muted:'#c7b3ff', hero:'#ede9fe', footer:'#2e1065', card:'#ffffff', block:'#efeaff' }) },
    { id:'aqua-tech', name:'Aqua Tech', palette:(b)=>({ primary:'#06b6d4', secondary:'#67e8f9', accent:'#3b82f6', bg:'#ecfeff', surface:'#cffafe', text:'#054e5b', muted:'#bae6fd', hero:'#e6fcff', footer:'#08303a', card:'#ffffff', block:'#f0fbfd' }) },
    { id:'earthy-tones', name:'Earthy Tones', palette:(b)=>({ primary:'#92400e', secondary:'#d97706', accent:'#a16207', bg:'#fffbeb', surface:'#fff7ed', text:'#3b2f2f', muted:'#d6cdbb', hero:'#fff7ed', footer:'#3a1d04', card:'#fff7ed', block:'#fdf6e8' }) },
    { id:'vivid-royal', name:'Vivid Royal', palette:(b)=>({ primary:'#7c3aed', secondary:'#22d3ee', accent:'#f59e0b', bg:'#071029', surface:'#0b1220', text:'#e6eefb', muted:'#3a3f55', hero:'#16213a', footer:'#071029', card:'#0b1220', block:'#051028' }) },
    { id:'slate-sky', name:'Slate Sky', palette:(b)=>({ primary:'#2563eb', secondary:'#94a3b8', accent:'#14b8a6', bg:'#f8fafc', surface:'#f1f5f9', text:'#0f172a', muted:'#cbd5e1', hero:'#e2e8f0', footer:'#0f172a', card:'#ffffff', block:'#f6f8fb' }) },
    { id:'rose-garden', name:'Rose Garden', palette:(b)=>({ primary:'#be123c', secondary:'#fb7185', accent:'#f472b6', bg:'#fff1f2', surface:'#ffe4e6', text:'#3f0a1a', muted:'#fecdd3', hero:'#ffe4e6', footer:'#7f1d1d', card:'#ffffff', block:'#fff5f7' }) },
    { id:'emerald-city', name:'Emerald City', palette:(b)=>({ primary:'#059669', secondary:'#10b981', accent:'#34d399', bg:'#ecfdf5', surface:'#d1fae5', text:'#053e37', muted:'#a7f3d0', hero:'#d1fae5', footer:'#064e3b', card:'#ffffff', block:'#e7f8f1' }) },
    { id:'amber-classic', name:'Amber Classic', palette:(b)=>({ primary:'#b45309', secondary:'#f59e0b', accent:'#d97706', bg:'#fffbeb', surface:'#fef3c7', text:'#3f2d1c', muted:'#f5d08a', hero:'#fde68a', footer:'#5b3412', card:'#ffffff', block:'#fff7d6' }) },
    { id:'midnight-blue', name:'Midnight Blue', palette:(b)=>({ primary:'#1e3a8a', secondary:'#3b82f6', accent:'#22d3ee', bg:'#0b1220', surface:'#0f172a', text:'#e2e8f0', muted:'#475569', hero:'#0f1f3a', footer:'#0b1220', card:'#111827', block:'#101827' }) },
    { id:'graphite', name:'Graphite', palette:(b)=>({ primary:'#111827', secondary:'#374151', accent:'#6b7280', bg:'#0f1115', surface:'#171923', text:'#e5e7eb', muted:'#4b5563', hero:'#10131c', footer:'#0b0d12', card:'#191c24', block:'#141720' }) },
    { id:'minty-fresh', name:'Minty Fresh', palette:(b)=>({ primary:'#22c55e', secondary:'#a7f3d0', accent:'#06b6d4', bg:'#ecfeff', surface:'#d1fae5', text:'#043b2c', muted:'#99f6e4', hero:'#d1fae5', footer:'#064e3b', card:'#ffffff', block:'#e8fbf4' }) },
    { id:'steel-modern', name:'Steel Modern', palette:(b)=>({ primary:'#3b82f6', secondary:'#64748b', accent:'#06b6d4', bg:'#f3f4f6', surface:'#e5e7eb', text:'#111827', muted:'#cbd5e1', hero:'#e2e8f0', footer:'#0f172a', card:'#ffffff', block:'#eef2f6' }) },
    { id:'peach-sorbet', name:'Peach Sorbet', palette:(b)=>({ primary:'#fb923c', secondary:'#fdba74', accent:'#f472b6', bg:'#fff7ed', surface:'#ffedd5', text:'#3a1d0b', muted:'#fed7aa', hero:'#ffe9d0', footer:'#6b2d12', card:'#ffffff', block:'#fff2e6' }) },
  ];

  // ========================= CSS Generator =========================
  function paletteCss(p){
    const safe = (v, fb='transparent')=> isDef(v)?v:fb;
    const textOnPrimary = ensureReadableTextColor(p.primary, p.text);
    const textOnSecondary = ensureReadableTextColor(p.secondary, p.text);
    const textOnAccent = ensureReadableTextColor(p.accent, p.text);
    const placeholder = darken(ensureReadableTextColor(p.surface||'#fff','#666'), .4);

    return `:root{ --theme-primary:${safe(p.primary)}; --theme-secondary:${safe(p.secondary)}; --theme-accent:${safe(p.accent)}; --theme-bg:${safe(p.bg,'#ffffff')}; --theme-surface:${safe(p.surface,p.bg)}; --theme-text:${safe(p.text,'#111111')}; --theme-muted:${safe(p.muted, darken(p.surface||p.bg||'#fff', .12))}; --theme-card:${safe(p.card, p.surface||p.bg)}; --theme-block:${safe(p.block, p.surface||p.bg)}; --theme-hero:${safe(p.hero, p.surface||p.bg)}; --theme-footer:${safe(p.footer, p.surface||p.bg)}; }

    html, body { background: var(--theme-bg) !important; color: var(--theme-text) !important; }

    /* Links */
    a, a:visited { color: var(--theme-primary) !important; }
    a:hover { filter: brightness(0.95); }

    /* Headings & text */
    h1,h2,h3,h4,h5,h6, p, span, li, blockquote { color: var(--theme-text) !important; }

    /* Header & Nav */
    header, .site-header, .navbar, .nav-bar, .topbar, [role="navigation"], .global-header { background: var(--theme-primary) !important; color: ${textOnPrimary} !important; border-bottom:1px solid var(--theme-muted) !important; }
    header a, .navbar a, .nav-bar a, .topbar a, [role="navigation"] a { color: ${textOnPrimary} !important; }
    header .btn, .navbar .btn, .nav-bar .btn { background: var(--theme-secondary) !important; color:${textOnSecondary} !important; }

    /* Hero */
    .hero, .hero-section, .jumbotron, .page-hero, .banner, .page-banner, .masthead-hero { background: var(--theme-hero) !important; color: var(--theme-text) !important; }

    /* Sections & Blocks */
    section, .section, .content-section, .block, .feature, .features, .module, .panel { background: var(--theme-block) !important; color: var(--theme-text) !important; }

    /* Cards */
    .card, .panel, .tile, .box, .well, .portlet, .card-body, .card-inner, .feature-card, .service-card { background: var(--theme-card) !important; color: var(--theme-text) !important; border:1px solid var(--theme-muted) !important; border-radius: 10px; }

    /* Buttons */
    button, .btn, a.button, a.btn, [role="button"], input[type="button"], input[type="submit"], .badge, .chip, .tag, .cta { background: var(--theme-primary) !important; color: ${textOnPrimary} !important; border:1px solid var(--theme-primary) !important; }
    button:hover, .btn:hover, a.button:hover, a.btn:hover { filter: brightness(0.95); }
    .btn-secondary, .button.secondary { background: var(--theme-secondary) !important; color:${textOnSecondary} !important; border-color: var(--theme-secondary) !important; }
    .btn-accent, .button.accent { background: var(--theme-accent) !important; color:${textOnAccent} !important; border-color: var(--theme-accent) !important; }

    /* Forms */
    input, textarea, select, label, fieldset, legend, .form, .form-control, .input { background: var(--theme-surface) !important; color: var(--theme-text) !important; border:1px solid var(--theme-muted) !important; }
    input::placeholder, textarea::placeholder { color: ${placeholder} !important; }
    input:focus, textarea:focus, select:focus { border-color: var(--theme-primary) !important; outline: 2px solid ${lighten(p.primary||'#000',.2)} !important; outline-offset: 1px; }

    /* Tables */
    table, .table, th, td, thead, tbody, tfoot { color: var(--theme-text) !important; border-color: var(--theme-muted) !important; }
    thead, th { background: ${lighten(p.surface||p.bg||'#fff', .06)} !important; }
    .table-striped tr:nth-child(odd) { background: ${lighten(p.surface||p.bg||'#fff', .04)} !important; }

    /* Alerts */
    .alert, .notice, .callout, .toast, .message, .notification { background: ${lighten(p.accent||'#eee', .45)} !important; border:1px solid var(--theme-accent) !important; color: ${ensureReadableTextColor(lighten(p.accent||'#eee', .45), p.text)} !important; }

    /* Footer */
    footer, .site-footer, .page-footer, [role="contentinfo"], .footbar { background: var(--theme-footer) !important; color: ${ensureReadableTextColor(p.footer||p.surface||p.bg||'#fff', p.text)} !important; border-top:1px solid var(--theme-muted) !important; }

    /* Dropdowns & Modals */
    .dropdown, .dropdown-menu, .modal, .dialog, [role="dialog"], .toolbar, .sidebar, .aside { background: var(--theme-surface) !important; color: var(--theme-text) !important; border:1px solid var(--theme-muted) !important; }

    /* Pagination */
    .pagination a, .pagination button { background: var(--theme-surface) !important; color: var(--theme-text) !important; border:1px solid var(--theme-muted) !important; }
    .pagination .active a, .pagination .active button { background: var(--theme-primary) !important; color:${textOnPrimary} !important; border-color: var(--theme-primary) !important; }
    `;
  }

  // ========================= Apply & Clear =========================
  function applyPaletteToDoc(doc, palette){ if(!doc) return; try{
    let tag = doc.getElementById('sgwm-theme-override-pro');
    if(!tag){ tag = doc.createElement('style'); tag.id='sgwm-theme-override-pro'; (doc.head||doc.documentElement).appendChild(tag); }
    tag.textContent = paletteCss(palette);
    // also set variables directly for inline CSS usage
    const root = doc.documentElement; const entries=[['--theme-primary',palette.primary],['--theme-secondary',palette.secondary],['--theme-accent',palette.accent],['--theme-bg',palette.bg],['--theme-surface',palette.surface],['--theme-text',palette.text],['--theme-muted',palette.muted],['--theme-card',palette.card||palette.surface],['--theme-block',palette.block||palette.surface],['--theme-hero',palette.hero||palette.surface],['--theme-footer',palette.footer||palette.surface]];
    entries.forEach(([k,v])=>{ try{ root.style.setProperty(k, v); }catch{} });
  }catch(e){ console.error('applyPaletteToDoc error', e); } }
  function clearThemeInDoc(doc){ if(!doc) return; const s=doc.getElementById('sgwm-theme-override-pro'); if(s) s.remove(); }

  // ========================= Base Palette Detection =========================
  function readBasePalette(doc){ try{
    const RS = (el)=> el ? doc.defaultView.getComputedStyle(el) : null;
    const root = RS(doc.documentElement), body = RS(doc.body);
    const tryVars = ['--color-primary','--primary','--brand','--accent','--theme-primary','--color-main'];
    let primary = null; if(root) for(const v of tryVars){ const val=root.getPropertyValue(v).trim(); if(val){ primary = hex(val); if(primary) break; } }
    if(!primary){ const a=doc.querySelector('a'); const c=RS(a||doc.body)?.color; primary = hex(c)||'#3366ff'; }
    const bg = hex(body?.backgroundColor||root?.backgroundColor)||'#ffffff';
    const text = hex(body?.color||'#111')||'#111111';
    return { primary, bg, text };
  }catch{ return { primary:'#3366ff', bg:'#ffffff', text:'#111111' }; } }

  // ========================= State =========================
  let BASE = { primary:'#3366ff', bg:'#ffffff', text:'#111111' };
  let CURRENT = null; // { id, name, palette, cssText }
  let STRUCTURE = null; // detected nodes map

  // ========================= UI (Shadow DOM) =========================
  function mountUi(){
    const host = document.getElementById('sgwm-pro-host'); if(!host) return;
    const root = host.attachShadow({mode:'open'});
    root.innerHTML = `
      <style>
        :host{ all: initial; }
        .fab{ position:fixed; right:0; bottom:0; transform: translate(-20px,-70px); z-index:1; width:56px; height:56px; border-radius:9999px; border:1px solid rgba(0,0,0,.08); background:#fff; box-shadow: 0 10px 25px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06); display:grid; place-items:center; cursor:pointer; transition: transform .15s ease, box-shadow .15s ease; }
        .fab:hover{ transform: translate(-20px,-70px) scale(1.05); box-shadow: 0 12px 28px rgba(0,0,0,.12), 0 3px 10px rgba(0,0,0,.08); }
        .panel{ position:fixed; right:0; bottom:0; transform: translate(-20px,-138px); width: 460px; max-height: 78vh; overflow:auto; background:#fff; color:#111; border:1px solid rgba(0,0,0,.08); border-radius:14px; box-shadow: 0 24px 48px rgba(0,0,0,.12); display:none; padding-bottom: 14px; }
        .panel.open{ display:block; }
        .hdr{ position:sticky; top:0; background:#fff; padding:12px 14px; border-bottom:1px solid rgba(0,0,0,.06); z-index:2 }
        .title{ font-weight:800; font-size:14px; }
        .sub{ font-size:12px; color:#666; margin-top:2px; }
        .sec{ padding:12px 14px; }
        .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
        .card{ border:1px solid rgba(0,0,0,.06); border-radius:10px; padding:10px; cursor:pointer; background:#fff; }
        .card:hover{ box-shadow:0 8px 18px rgba(0,0,0,.06); transform: translateY(-2px); }
        .card-name{ font-size:13px; font-weight:700; margin-bottom:8px; }
        .band{ display:grid; grid-template-columns: repeat(6, 1fr); gap:4px; }
        .sw{ height:18px; border-radius:6px; border:1px solid rgba(0,0,0,.08); }
        .row{ display:flex; gap:8px; align-items:center; }
        .pill{ padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(0,0,0,.08); background:#fafafa; cursor:pointer; }
        .muted{ color:#777; font-size:11px; }
        .divider{ height:1px; background:rgba(0,0,0,.06); margin:10px -14px; }
        .controls{ display:flex; gap:8px; flex-wrap:wrap; }
        .color{ width:44px; height:28px; border-radius:6px; border:1px solid rgba(0,0,0,.08); padding:2px; }
        .sec-title{ font-weight:700; font-size:13px; margin-bottom:8px }
        .footer{ padding: 10px 14px; border-top:1px solid rgba(0,0,0,.06); display:flex; gap:8px; align-items:center; justify-content:space-between }
        .btn-primary{ background:#6b46c1; color:#fff; border-radius:8px; padding:8px 12px; border:none; cursor:pointer }
        .small{ font-size:12px }
        @media (max-width: 520px) { .panel{ width:auto; right:0; left:0; transform: translate(0, -120px); margin: 0 10px; } .fab{ transform: translate(-12px,-62px); } }
      </style>
      <button class="fab" id="fab" title="Theme (colors)">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3C7.03 3 3 7.03 3 12c0 3.31 2.69 6 6 6h1.25a1.75 1.75 0 0 1 0 3.5H10c-4.97 0-9-4.03-9-9S5.03 3 10 3s9 4.03 9 9c0 1.66-1.34 3-3 3h-1.25a1.75 1.75 0 0 1 0-3.5H16c.83 0 1.5-.67 1.5-1.5C17.5 7.47 15.03 5 12 5" stroke="#6b46c1" stroke-width="1.8" stroke-linecap="round"/>
          <circle cx="8" cy="10" r="1.25" fill="#6b46c1"/>
          <circle cx="11.5" cy="8.5" r="1.25" fill="#22d3ee"/>
          <circle cx="14.5" cy="11" r="1.25" fill="#f472b6"/>
          <circle cx="10" cy="13.5" r="1.25" fill="#f59e0b"/>
        </svg>
      </button>
      <div class="panel" id="panel" role="dialog" aria-modal="false" aria-label="SGWM Pro Theme">
        <div class="hdr">
          <div class="title">SGWM Pro — Universal Theme Engine</div>
          <div class="sub">Semantic auto-map • 24+ themes • per-section overrides • WCAG contrast</div>
        </div>

        <div class="sec">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="muted">Detected base</div>
              <div class="row" style="margin-top:6px">
                <div style="width:120px"><div class="muted">Primary</div><div class="sw" id="b-primary"></div></div>
                <div style="width:120px"><div class="muted">Background</div><div class="sw" id="b-bg"></div></div>
                <div style="width:120px"><div class="muted">Text</div><div class="sw" id="b-text"></div></div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <button class="pill" id="refresh">Refresh</button>
              <button class="pill" id="clear">Reset</button>
            </div>
          </div>
        </div>

        <div class="sec">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="sec-title">Professional Themes</div>
            <div class="muted small">Pick a starting palette</div>
          </div>
          <div class="grid" id="theme-grid"></div>
        </div>

        <div class="sec">
          <div class="sec-title">Manual Tweaks</div>
          <div class="row" style="justify-content:space-between;align-items:center;">
            <div><div class="muted">Primary</div><input type="color" id="pick-primary" class="color"></div>
            <div><div class="muted">Background</div><input type="color" id="pick-bg" class="color"></div>
            <div><div class="muted">Text</div><input type="color" id="pick-text" class="color"></div>
            <div><div class="muted">Surface</div><input type="color" id="pick-surface" class="color"></div>
          </div>
          <div style="margin-top:10px;" class="controls">
            <button id="apply" class="pill">Apply</button>
            <button id="save" class="pill">Save Preset</button>
            <button id="exportCss" class="pill">Get CSS</button>
          </div>
        </div>

        <div class="sec">
          <div class="sec-title">Per-Section Quick Map</div>
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <button class="pill" data-map="nav">Map Nav</button>
            <button class="pill" data-map="hero">Map Hero</button>
            <button class="pill" data-map="card">Map Cards</button>
            <button class="pill" data-map="button">Map Buttons</button>
            <button class="pill" data-map="section">Map Sections</button>
            <button class="pill" data-map="footer">Map Footer</button>
          </div>
          <div class="muted" style="margin-top:8px">Detected live on this template. If a category doesn't respond, click Refresh first.</div>
        </div>

        <div class="footer">
          <div class="muted">State persists in window.SGWM_PRO_THEME & localStorage</div>
          <div style="display:flex;gap:8px"><button id="applyNow" class="btn-primary">Apply Now</button></div>
        </div>
      </div>
    `;

    // Wire UI
    const $ = (sel)=> root.querySelector(sel);
    const $panel = $('#panel');
    $('#fab').addEventListener('click', ()=>{ if(!$panel.classList.contains('open')) refreshBaseAndGrid(); $panel.classList.toggle('open'); });
    $('#refresh').addEventListener('click', refreshBaseAndGrid);
    $('#clear').addEventListener('click', ()=>{ clearTheme(); alert('Theme cleared'); });
    $('#apply').addEventListener('click', ()=>{ applyManual(); alert('Applied'); });
    $('#save').addEventListener('click', savePreset);
    $('#exportCss').addEventListener('click', ()=>{ const css=getActiveCss(); prompt('Copy CSS below (save as css/sgwm-theme.css in your export):', css); });
    $('#applyNow').addEventListener('click', ()=>{ applyManual(); alert('Theme applied'); });
    root.querySelectorAll('[data-map]').forEach(btn=> btn.addEventListener('click', (e)=>{ const k=e.currentTarget.getAttribute('data-map'); quickMap(k); }));

    // Populate grid
    function buildGrid(){ const grid = $('#theme-grid'); grid.innerHTML=''; THEMES.forEach(def=>{
      const p = def.palette(BASE);
      const card = document.createElement('div'); card.className='card'; card.setAttribute('role','button');
      card.innerHTML = `<div class="card-name">${def.name}</div><div class="band">`
        + [`primary`,`secondary`,`accent`,`bg`,`surface`,`text`].map(k=>`<div class="sw" style="background:${p[k]}"></div>`).join('')
        + `</div>`;
      card.addEventListener('click', ()=> onPickTheme(def));
      grid.appendChild(card);
    }); }

    function refreshBaseAndGrid(){ BASE = readBasePalette(getPreviewDocument())||BASE; $('#b-primary').style.background=BASE.primary; $('#b-bg').style.background=BASE.bg; $('#b-text').style.background=BASE.text; STRUCTURE = detectStructure(getPreviewDocument()); buildGrid(); presetPickersFromCurrent(); }

    function presetPickersFromCurrent(){ try{ if(!CURRENT) return; $('#pick-primary').value = rgbToHex(parseColor(CURRENT.palette.primary)); $('#pick-bg').value = rgbToHex(parseColor(CURRENT.palette.bg)); $('#pick-text').value = rgbToHex(parseColor(CURRENT.palette.text)); $('#pick-surface').value = rgbToHex(parseColor(CURRENT.palette.surface)); }catch{} }

    function onPickTheme(def){ const doc=getPreviewDocument(); const palette=normalizePalette(def.palette(BASE)); CURRENT={ id:def.id, name:def.name, palette, cssText: paletteCss(palette) }; applyPaletteToDoc(doc, palette); saveState(); presetPickersFromCurrent(); }

    // manual pickers live-update
    ['pick-primary','pick-bg','pick-text','pick-surface'].forEach(id=>{ const el=$("#"+id); el.addEventListener('input', ()=>{ if(!CURRENT) CURRENT={id:'custom',name:'Custom',palette:{}}; const p=CURRENT.palette; p.primary=($('#pick-primary').value)||p.primary; p.bg=($('#pick-bg').value)||p.bg; p.text=($('#pick-text').value)||p.text; p.surface=($('#pick-surface').value)||p.surface; p.muted=p.muted||lighten(p.surface||p.bg||'#fff', .07); p.card=p.card||p.surface; CURRENT.cssText=paletteCss(p); applyPaletteToDoc(getPreviewDocument(), p); saveState(); }); });

    function applyManual(){ if(!CURRENT) CURRENT={id:'custom',name:'Custom',palette:{}}; const p=CURRENT.palette; p.primary=$('#pick-primary').value||p.primary||BASE.primary; p.bg=$('#pick-bg').value||p.bg||BASE.bg; p.text=$('#pick-text').value||p.text||BASE.text; p.surface=$('#pick-surface').value||p.surface||(p.bg||BASE.bg); p.muted=p.muted||lighten(p.surface||p.bg||'#fff', .07); CURRENT.cssText=paletteCss(p); applyPaletteToDoc(getPreviewDocument(), p); saveState(); }

    function quickMap(kind){ const doc=getPreviewDocument(); if(!doc){ alert('Preview not found'); return; } if(!CURRENT){ alert('Pick a theme first'); return; } if(!STRUCTURE) STRUCTURE = detectStructure(doc);
      const list = (STRUCTURE[kind]||[]); if(list.length===0){ alert('No elements detected for "'+kind+'". Click Refresh and try again.'); return; }
      const p=CURRENT.palette; const textOnPrimary=ensureReadableTextColor(p.primary,p.text);
      list.forEach(el=>{ try{
        if(kind==='nav' || kind==='header') { el.style.background=p.primary; el.style.color=textOnPrimary; el.querySelectorAll('a,button,.btn').forEach(x=>{ x.style.color=textOnPrimary; }); }
        else if(kind==='hero') { el.style.background=p.hero||p.surface||p.bg; el.style.color=p.text; }
        else if(kind==='card') { el.style.background=p.card||p.surface; el.style.borderColor=p.muted; el.style.color=p.text; }
        else if(kind==='button') { (el.matches('button,.btn,a.button,a.btn,[role="button"],input[type="button"],input[type="submit"]')?[el]:el.querySelectorAll('button,.btn,a.button,a.btn,[role="button"],input[type="button"],input[type="submit"]').forEach(btn=>{ btn.style.background=p.primary; btn.style.borderColor=p.primary; btn.style.color=textOnPrimary; })) }
        else if(kind==='section') { el.style.background=p.block||p.surface; el.style.color=p.text; }
        else if(kind==='footer') { el.style.background=p.footer||p.surface||p.bg; el.style.color=ensureReadableTextColor(p.footer||p.surface||p.bg, p.text); }
      }catch(e){} });
    }

    function savePreset(){ if(!CURRENT) return; const key='sgwm_pro_custom_presets'; const arr=JSON.parse(localStorage.getItem(key)||'[]'); arr.unshift(CURRENT); localStorage.setItem(key, JSON.stringify(arr.slice(0,20))); alert('Preset saved'); }

    function saveState(){ window.SGWM_PRO_THEME=CURRENT; try{ localStorage.setItem('sgwm_pro_theme', JSON.stringify(CURRENT)); }catch{} }

    // load previous
    try{ const saved=JSON.parse(localStorage.getItem('sgwm_pro_theme')); if(saved){ CURRENT=saved; window.SGWM_PRO_THEME=CURRENT; } }catch{}

    // initial
    (function init(){ BASE = readBasePalette(getPreviewDocument()); STRUCTURE = detectStructure(getPreviewDocument()); buildGrid(); $('#b-primary').style.background=BASE.primary; $('#b-bg').style.background=BASE.bg; $('#b-text').style.background=BASE.text; if(CURRENT) { applyPaletteToDoc(getPreviewDocument(), CURRENT.palette); presetPickersFromCurrent(); }
      // Observe preview for changes and re-inject theme
      try{ const doc=getPreviewDocument(); const observer = new MutationObserver(()=>{ if(CURRENT) applyPaletteToDoc(doc, CURRENT.palette); }); observer.observe(doc.documentElement||doc, { attributes:true, childList:true, subtree:true }); }catch{}
    })();
  }

  // Normalize palette (ensure keys + safe contrast)
  function normalizePalette(p){ const out={...p}; out.primary=out.primary||'#3366ff'; out.secondary=out.secondary||out.primary; out.bg=out.bg||'#ffffff'; out.surface=out.surface||out.bg; out.text=ensureReadableTextColor(out.bg, out.text||'#111'); out.muted=out.muted||darken(out.surface||out.bg,.12); out.card=out.card||out.surface; out.block=out.block||out.surface; out.hero=out.hero||out.surface; out.footer=out.footer||out.surface; return out; }

  // Clear theme (both doc & state)
  function clearTheme(){ const doc=getPreviewDocument(); clearThemeInDoc(doc); CURRENT=null; window.SGWM_PRO_THEME=null; try{ localStorage.removeItem('sgwm_pro_theme'); }catch{} }

  // Expose exporter helper
  window.SGWM_PRO_THEME = CURRENT;
  window.SGWM_PRO_THEME_EXPORTER = {
    getActiveCss(){ return window.SGWM_PRO_THEME?.cssText || ''; },
    ensureThemeInFiles(files, cssPath='css/sgwm-theme.css'){
      const theme = window.SGWM_PRO_THEME; if(!theme||!theme.cssText) return files;
      const out=[]; let hadHtml=false;
      const injectLink=(html, href)=>{ if(!html||typeof html!=='string') return html; if(new RegExp(`href=["']${href}["']`).test(html)) return html; const link=`<link rel="stylesheet" href="${href}">`;
        if(/<\/head>/i.test(html)) return html.replace(/<\/head>/i, `  ${link}\n</head>`);
        if(/<html[^>]*>/i.test(html)) return html.replace(/<html[^>]*>/i, m=>`${m}\n<head>\n  ${link}\n</head>`);
        if(/<body[^>]*>/i.test(html)) return html.replace(/<body[^>]*>/i, m=>`<head>\n  ${link}\n</head>\n${m}`);
        return `${link}\n${html}`; };
      for(const f of files){ const isHtml=/\.html?$/i.test(f.path); if(isHtml) hadHtml=true; if(isHtml){ const html=typeof f.content==='string'?f.content:(new TextDecoder('utf-8').decode(f.content)); const updated=injectLink(html, cssPath); out.push({ path:f.path, content:updated }); } else { out.push(f); } }
      out.push({ path: cssPath, content: theme.cssText });
      return out;
    }
  };

  // Mount UI now
  mountUi();
})();
</script>


 
</body>
</html>
