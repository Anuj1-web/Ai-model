<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wizard Maker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    header { background: #222; color: #fff; padding: 10px; }
    #tabs { display: flex; border-bottom: 1px solid #ccc; }
    #tabs button { padding: 8px 12px; border: none; cursor: pointer; background: #eee; }
    #tabs button.active { background: #ddd; font-weight: bold; }
    #iframe-container { height: 80vh; }
    iframe { width: 100%; height: 100%; border: none; }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
    .modal { background: white; padding: 20px; border-radius: 8px; width: 400px; }
    .modal section { margin-bottom: 12px; }
  </style>
</head>
<body>
  <header>
    <input type="file" id="zipInput" accept=".zip" />
    <button id="exportBtn">Export Edited ZIP</button>
  </header>

  <div id="tabs"></div>
  <div id="iframe-container"></div>

  <!-- Editor Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Edit Element</h3>
      <section id="textSection">
        <label>Text / Placeholder</label>
        <textarea id="modalText" style="width:100%;height:60px;"></textarea>
        <button id="applyTextBtn">Apply Text</button>
      </section>
      <section>
        <label>Color</label>
        <input type="color" id="modalColor" />
        <select id="colorTarget">
          <option value="text">Text</option>
          <option value="background">Background</option>
        </select>
        <button id="applyColorBtn">Apply Color</button>
      </section>
      <section>
        <label>Replace Image</label>
        <input type="file" id="modalImageFile" accept="image/*" />
        <input type="text" id="modalImageUrl" placeholder="Or paste image URL" style="width:100%;" />
        <button id="applyImageBtn">Apply Image</button>
      </section>
      <div style="text-align:right;">
        <button id="cancelBtn">Cancel</button>
        <button id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const zipInput = document.getElementById("zipInput");
    const exportBtn = document.getElementById("exportBtn");
    const tabs = document.getElementById("tabs");
    const iframeContainer = document.getElementById("iframe-container");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalText = document.getElementById("modalText");
    const modalColor = document.getElementById("modalColor");
    const colorTarget = document.getElementById("colorTarget");
    const modalImageFile = document.getElementById("modalImageFile");
    const modalImageUrl = document.getElementById("modalImageUrl");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");
    const applyTextBtn = document.getElementById("applyTextBtn");
    const applyColorBtn = document.getElementById("applyColorBtn");
    const applyImageBtn = document.getElementById("applyImageBtn");

    let zipFileStructure = {}; 
    let editedHTML = {};       
    let iframeRefs = {};
    let modalTarget = null;
    let originalSnapshotHTML = null;

    // Load ZIP
    zipInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const jszip = new JSZip();
      const zip = await jszip.loadAsync(file);

      tabs.innerHTML = "";
      iframeContainer.innerHTML = "";
      zipFileStructure = {};

      await Promise.all(Object.keys(zip.files).map(async (filename) => {
        if (!zip.files[filename].dir) {
          zipFileStructure[filename] = await zip.files[filename].async("uint8array");
        }
      }));

      Object.keys(zipFileStructure).forEach((filename, idx) => {
        if (filename.endsWith(".html")) {
          const btn = document.createElement("button");
          btn.textContent = filename;
          btn.onclick = () => openTab(filename);
          tabs.appendChild(btn);
          if (idx === 0) openTab(filename);
        }
      });
    });

    function openTab(pageName) {
      [...tabs.children].forEach(b => b.classList.remove("active"));
      const btn = [...tabs.children].find(b => b.textContent === pageName);
      if (btn) btn.classList.add("active");

      const html = editedHTML[pageName] 
        ? editedHTML[pageName] 
        : new TextDecoder().decode(zipFileStructure[pageName]);
      iframeContainer.innerHTML = `<iframe srcdoc="${html}"></iframe>`;
      const iframe = iframeContainer.querySelector("iframe");
      iframeRefs[pageName] = iframe;

      iframe.addEventListener("load", () => {
        let doc = iframe.contentDocument;
        let htmlWithBridge = injectEditingBridge(doc.documentElement.outerHTML, pageName);
        iframe.srcdoc = htmlWithBridge;
      });
    }

    function injectEditingBridge(html, pageName) {
      const bridge = `<script>(function(){
        var EDIT_ATTR='data-edit-id';
        var clickTimer=null;
        var delay=250;

        function ensureId(el){
          if(!el.getAttribute(EDIT_ATTR)) 
            el.setAttribute(EDIT_ATTR,'e'+Math.random().toString(36).slice(2,9));
          return el.getAttribute(EDIT_ATTR);
        }

        function buildSnapshot(el){
          return {
            text: el.innerText||'',
            placeholder: ('placeholder' in el ? el.placeholder : undefined),
            src: (el.tagName==='IMG'?el.src:undefined),
            inline:{color:el.style.color,backgroundColor:el.style.backgroundColor}
          };
        }

        document.addEventListener('click', function(e){
          if(clickTimer){ 
            clearTimeout(clickTimer);
            clickTimer=null;
            e.preventDefault(); e.stopPropagation();
            var el=e.target; if(!el) return;
            var id=ensureId(el);
            var snap=buildSnapshot(el);
            parent.postMessage({type:'OPEN_EDITOR',page:'${pageName}',id:id,hasText:!!el.innerText,...snap},'*');
          } else {
            clickTimer=setTimeout(()=>{clickTimer=null;},delay);
          }
        }, true);

        window.addEventListener('message', function(ev){
          var d=ev.data||{};
          var el=document.querySelector('['+EDIT_ATTR+'="'+d.id+'"]');
          if(!el) return;
          if(d.type==='APPLY_TEXT') el.innerText=d.text||'';
          if(d.type==='APPLY_COLOR'){
            if(d.target==='background') el.style.backgroundColor=d.color;
            else el.style.color=d.color;
          }
          if(d.type==='APPLY_IMAGE'&&el.tagName==='IMG') el.src=d.src;
        });
      })();<\/script>`;
      return html.replace(/<\/body>/i, bridge + "</body>");
    }

    // Modal logic
    window.addEventListener("message", (event) => {
      const d = event.data || {};
      if (d.type === "OPEN_EDITOR") {
        modalTarget = { page: d.page, id: d.id, hasText: !!d.hasText };
        modalText.value = d.text || "";
        modalColor.value = "#000000";
        originalSnapshotHTML = iframeRefs[d.page].contentDocument.documentElement.outerHTML;
        modalBackdrop.style.display = "flex";
        document.getElementById("textSection").style.display = d.hasText ? "block" : "none";
      }
    });

    applyTextBtn.onclick = () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_TEXT",id,text:modalText.value},"*");
    };
    applyColorBtn.onclick = () => {
      const {page,id} = modalTarget;
      iframeRefs[page].contentWindow.postMessage({type:"APPLY_COLOR",id,color:modalColor.value,target:colorTarget.value},"*");
    };
    applyImageBtn.onclick = () => {
      const {page,id} = modalTarget;
      if (modalImageFile.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:e.target.result},"*");
        };
        reader.readAsDataURL(modalImageFile.files[0]);
      } else if (modalImageUrl.value) {
        iframeRefs[page].contentWindow.postMessage({type:"APPLY_IMAGE",id,src:modalImageUrl.value},"*");
      }
    };

    cancelBtn.onclick = () => {
      if(modalTarget){
        const iframe = iframeRefs[modalTarget.page];
        if(iframe && originalSnapshotHTML){
          iframe.srcdoc = originalSnapshotHTML; 
        }
      }
      modalBackdrop.style.display = "none";
    };

    saveBtn.onclick = () => {
      const {page} = modalTarget;
      const html = iframeRefs[page].contentDocument.documentElement.outerHTML;
      editedHTML[page] = html;
      modalBackdrop.style.display = "none";
    };

    // Export ZIP with structure preserved
    exportBtn.onclick = () => {
      const zip = new JSZip();
      Object.keys(zipFileStructure).forEach(filename => {
        if (filename.endsWith(".html") && editedHTML[filename]) {
          zip.file(filename, editedHTML[filename]);
        } else {
          zip.file(filename, zipFileStructure[filename]);
        }
      });
      zip.generateAsync({type:"blob"}).then(blob => saveAs(blob,"edited.zip"));
    };
  </script>
</body>
</html>
