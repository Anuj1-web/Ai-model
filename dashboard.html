<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 0;
    }
    header {
      background: #f5f5f5;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
    }
    .nav-links {
      display: flex;
      gap: 10px;
    }
    .nav-btn {
      background: #000;
      color: #fff;
      padding: 10px 18px;
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.2s;
      font-size: 15px;
      border: none;
      cursor: pointer;
    }
    .nav-btn:hover {
      background: #333;
    }
    main {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
    }
    section h2 {
      margin-top: 0;
      font-size: 18px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #000;
      color: #fff;
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-top: 12px;
      font-size: 15px;
    }
    button:hover {
      background: #333;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      background: #000;
      color: #fff;
      border-radius: 6px;
      z-index: 9999;
      opacity: 0.95;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard</h1>
    <nav class="nav-links">
      <a href="index.html" class="nav-btn">Home</a>
      <button id="logoutBtn" class="nav-btn">Logout</button>
    </nav>
  </header>

  <main>
    <!-- Account Info -->
    <section id="accountSection">
      <h2>Account Information</h2>
      <form id="accountForm">
        <label>Email</label>
        <input type="email" id="accountEmail" disabled />

        <label>Change Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password" />

        <button type="submit">Update Account</button>
      </form>
    </section>

    <!-- Activity Tracking -->
    <section id="activitySection">
      <h2>Recent Activity</h2>
      <ul id="activityList">
        <li>No recent activity.</li>
      </ul>
    </section>

    <!-- Subscription -->
    <section id="subscriptionSection">
      <h2>Subscription</h2>
      <div id="subscriptionBox">Loading subscription details...</div>
    </section>
  </main>

  <div id="toastContainer"></div>

  <script type="module">
    import { 
      onAuthStateChanged, 
      signOut, 
      sendEmailVerification, 
      updatePassword, 
      reload 
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    import { 
      doc, 
      getDoc, 
      collection, 
      addDoc, 
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    import { auth, db } from "./firebase-login.js";

    const emailInput = document.getElementById("accountEmail");
    const passwordInput = document.getElementById("newPassword");
    const accountForm = document.getElementById("accountForm");
    const logoutBtn = document.getElementById("logoutBtn");
    const toastContainer = document.getElementById("toastContainer");
    const activityList = document.getElementById("activityList");
    const subscriptionBox = document.getElementById("subscriptionBox");

    function showToast(msg) {
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = msg;
      toastContainer.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }

    // Load subscription
    fetch("subscription.html")
      .then(r => r.ok ? r.text() : null)
      .then(html => {
        subscriptionBox.innerHTML = html || "📦 Coming soon...";
      })
      .catch(() => subscriptionBox.innerHTML = "📦 Coming soon...");

    // Load activity
    async function loadActivity(uid) {
      try {
        const snap = await getDoc(doc(db, "users", uid));
        const userData = snap.exists() ? snap.data() : {};
        const activity = userData.activity || [];
        activityList.innerHTML = "";
        if (activity.length === 0) {
          activityList.innerHTML = "<li>No recent activity.</li>";
        } else {
          activity.forEach(act => {
            const li = document.createElement("li");
            li.textContent = `${act.action} - ${new Date(act.time.seconds*1000).toLocaleString()}`;
            activityList.appendChild(li);
          });
        }
      } catch (err) {
        console.error("Activity load failed", err);
      }
    }

    // Auth state
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      emailInput.value = user.email;
      await loadActivity(user.uid);
    });

    // Update account with verification
    accountForm.addEventListener("submit", async e => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const newPass = passwordInput.value.trim();
      if (!newPass) {
        showToast("⚠️ Please enter a new password.");
        return;
      }

      await reload(user); // refresh user state

      if (!user.emailVerified) {
        await sendEmailVerification(user);
        showToast("📧 Verification email sent. Please verify before changing password.");
        return;
      }

      try {
        await updatePassword(user, newPass);
        showToast("✅ Password updated successfully!");

        // log activity
        await addDoc(collection(db, "users", user.uid, "activities"), {
          action: "Updated account password",
          time: serverTimestamp()
        });
        await loadActivity(user.uid);

      } catch (err) {
        console.error(err);
        showToast("❌ Failed to update password.");
      }

      passwordInput.value = "";
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
