<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sitegen Library</title>
  <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 24px;
      font-weight: bold;
    }
    .upload-btn {
      background: black;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
    }
    .card-body {
      padding: 12px;
    }
    .card-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .card-actions button {
      margin-right: 6px;
      background: black;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      width: 100%;
    }
    #cropper-container {
      max-height: 400px;
      overflow: hidden;
    }
    #cropper-container img {
      max-width: 100%;
    }
    .progress-container {
      margin: 10px 0;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      height: 8px;
    }
    .progress-bar {
      height: 100%;
      background: black;
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“‚ Sitegen Library</h1>
    <input type="file" id="uploadFile" hidden />
    <button class="upload-btn" onclick="document.getElementById('uploadFile').click()">Upload</button>
  </header>

  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

  <div class="library-grid" id="libraryGrid"></div>

  <!-- Thumbnail Editor Modal -->
  <div class="modal" id="thumbnailModal">
    <div class="modal-content">
      <h2>Edit Thumbnail</h2>
      <div id="cropper-container"><img id="cropperImage" src="" /></div>
      <div style="margin-top:10px;">
        <button onclick="saveCroppedThumbnail()">Save Thumbnail</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/jszip"></script>
  <script src="https://unpkg.com/cropperjs"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let library = JSON.parse(localStorage.getItem("library")) || [];
    let currentEditId = null;
    let cropper;

    const libraryGrid = document.getElementById("libraryGrid");
    const progressBar = document.getElementById("progressBar");

    function renderLibrary() {
      libraryGrid.innerHTML = "";
      library.forEach((item, index) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${item.thumbnail || 'https://via.placeholder.com/280x160?text=No+Thumbnail'}" />
          <div class="card-body">
            <div class="card-title">${item.name}</div>
            <div class="card-actions">
              <button onclick="openThumbnailEditor(${index})">Edit Thumbnail</button>
              <button onclick="deleteItem(${index})">Delete</button>
            </div>
          </div>`;
        libraryGrid.appendChild(card);
      });
    }

    function saveLibrary() {
      localStorage.setItem("library", JSON.stringify(library));
    }

    document.getElementById("uploadFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const type = file.name.endsWith(".zip") ? "template" : "other";

      // Progress bar simulation
      progressBar.style.width = "0%";
      let progress = 0;
      const interval = setInterval(() => {
        if (progress >= 100) {
          clearInterval(interval);
        } else {
          progress += 10;
          progressBar.style.width = progress + "%";
        }
      }, 200);

      if (type === "template") {
        const zip = await JSZip.loadAsync(file);
        const indexHtml = await zip.file("index.html").async("string");
        const iframe = document.createElement("iframe");
        iframe.style.display = "none";
        document.body.appendChild(iframe);
        iframe.contentDocument.open();
        iframe.contentDocument.write(indexHtml);
        iframe.contentDocument.close();

        iframe.onload = async () => {
          const canvas = await html2canvas(iframe.contentDocument.body);
          const thumbnail = canvas.toDataURL("image/png");
          const item = { id: Date.now(), name: file.name, type, thumbnail };
          library.push(item);
          saveLibrary();
          renderLibrary();
          iframe.remove();
        };
      } else {
        const item = { id: Date.now(), name: file.name, type, thumbnail: null };
        library.push(item);
        saveLibrary();
        renderLibrary();
      }
    });

    function openThumbnailEditor(index) {
      currentEditId = index;
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          document.getElementById("thumbnailModal").style.display = "flex";
          const img = document.getElementById("cropperImage");
          img.src = reader.result;
          if (cropper) cropper.destroy();
          img.onload = () => {
            cropper = new Cropper(img, {
              aspectRatio: 280/160,
              viewMode: 1,
              dragMode: 'move',
              responsive: true,
              autoCropArea: 1
            });
          };
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    function saveCroppedThumbnail() {
      if (!cropper || currentEditId === null) return;
      const canvas = cropper.getCroppedCanvas({ width: 280, height: 160 });
      library[currentEditId].thumbnail = canvas.toDataURL("image/png");
      saveLibrary();
      renderLibrary();
      closeModal();
    }

    function closeModal() {
      document.getElementById("thumbnailModal").style.display = "none";
      if (cropper) cropper.destroy();
    }

    function deleteItem(index) {
      library.splice(index, 1);
      saveLibrary();
      renderLibrary();
    }

    // Initial render
    renderLibrary();
  </script>
</body>
</html>
