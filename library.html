<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sitegen Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-white text-black min-h-screen flex flex-col">
  <!-- Header -->
  <header class="p-4 border-b flex justify-between items-center">
    <h1 class="text-2xl font-bold">Sitegen Library</h1>
    <nav>
      <a href="index.html" class="px-4 py-2 bg-black text-white rounded">Home</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="flex-1 p-6 max-w-6xl mx-auto w-full">
    <!-- Upload Section -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold mb-4">Upload New Item</h2>
      <div class="flex flex-col md:flex-row gap-3 md:items-center">
        <select id="category" class="border px-3 py-2 rounded">
          <option value="Template">Template</option>
          <option value="Block">Block</option>
          <option value="Theme">Theme</option>
          <option value="Subscription Box">Subscription Box</option>
        </select>
        <input type="file" id="fileInput" class="border px-3 py-2 rounded bg-white">
        <button onclick="uploadItem()" class="bg-black text-white px-4 py-2 rounded">Upload</button>
      </div>

      <!-- Progress Bar -->
      <div id="progressBox" class="hidden mt-4 w-full">
        <p id="progressText" class="text-sm">Uploading 0%</p>
        <div class="w-full bg-gray-200 rounded h-2 mt-1">
          <div id="progressBar" class="bg-black h-2 rounded" style="width:0%"></div>
        </div>
      </div>
    </section>

    <!-- Library Section -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Library Items</h2>
      <div id="libraryItems" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>
  </main>

  <script>
    // Fake smooth progress bar
    function fakeProgress(cb) {
      let percent = 0;
      const interval = setInterval(() => {
        percent += 5;
        if (percent > 90) clearInterval(interval);
        cb(percent);
      }, 120);
      return interval;
    }

    function updateProgress(percent) {
      document.getElementById("progressText").textContent = `Uploading ${percent}%`;
      document.getElementById("progressBar").style.width = percent + "%";
    }

    function uploadItem() {
      const category = document.getElementById("category").value;
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) return alert("Please select a file.");

      const file = fileInput.files[0];
      const reader = new FileReader();

      document.getElementById("progressBox").classList.remove("hidden");
      let fake = fakeProgress(updateProgress);

      reader.onload = function(e) {
        clearInterval(fake);
        updateProgress(100);

        const content = e.target.result;
        const name = file.name.replace(/\.[^/.]+$/, "");

        // Create hidden iframe for rendering
        const iframe = document.createElement("iframe");
        iframe.style.position = "absolute";
        iframe.style.left = "-9999px";
        iframe.style.top = "-9999px";
        iframe.style.width = "1200px";
        iframe.style.height = "800px";
        document.body.appendChild(iframe);

        iframe.contentDocument.open();
        iframe.contentDocument.write(content);
        iframe.contentDocument.close();

        // Give time for assets to load
        setTimeout(() => {
          html2canvas(iframe.contentDocument.body, { useCORS:true, scale:0.3 }).then(canvas => {
            const preview = canvas.toDataURL("image/png");

            const newItem = { name, category, content, preview };
            const library = JSON.parse(localStorage.getItem("sitegenLibrary")) || [];
            library.push(newItem);
            localStorage.setItem("sitegenLibrary", JSON.stringify(library));

            loadLibrary();
            iframe.remove();
          });
        }, 1000);
      };
      reader.readAsText(file);
    }

    function loadLibrary() {
      const library = JSON.parse(localStorage.getItem("sitegenLibrary")) || [];
      const container = document.getElementById("libraryItems");
      container.innerHTML = "";
      library.forEach((item, idx) => {
        const card = document.createElement("div");
        card.className = "border rounded-lg shadow p-4 flex flex-col bg-white";

        const img = document.createElement("img");
        img.src = item.preview || "";
        img.alt = item.name;
        img.className = "w-full h-48 object-contain rounded mb-3 bg-gray-50";

        const title = document.createElement("h3");
        title.className = "font-semibold text-lg mb-1";
        title.textContent = item.name;

        const cat = document.createElement("p");
        cat.className = "text-sm text-gray-600 mb-3";
        cat.textContent = item.category;

        const btn = document.createElement("button");
        btn.className = "bg-black text-white px-4 py-2 rounded";
        btn.textContent = "Remove";
        btn.onclick = () => removeItem(idx);

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(cat);
        card.appendChild(btn);
        container.appendChild(card);
      });
    }

    function removeItem(idx) {
      const library = JSON.parse(localStorage.getItem("sitegenLibrary")) || [];
      library.splice(idx, 1);
      localStorage.setItem("sitegenLibrary", JSON.stringify(library));
      loadLibrary();
    }

    window.onload = loadLibrary;
  </script>
</body>
</html>
