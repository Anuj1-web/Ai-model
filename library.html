<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sitegen Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-white text-black min-h-screen p-6">
  <header class="mb-6 flex justify-between items-center">
    <h1 class="text-3xl font-bold">ðŸ“š Sitegen Library</h1>
    <label class="px-4 py-2 bg-black text-white rounded cursor-pointer">
      Upload ZIP
      <input type="file" id="uploadInput" accept=".zip" class="hidden">
    </label>
  </header>

  <!-- Progress Bar -->
  <div id="progressContainer" class="w-full bg-gray-200 rounded h-4 hidden mb-6">
    <div id="progressBar" class="bg-black h-4 w-0 rounded"></div>
  </div>

  <!-- Sections -->
  <div id="library">
    <section id="Templates">
      <h2 class="text-2xl font-semibold mb-3">ðŸ“‚ Templates</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="TemplatesGrid"></div>
    </section>
    <section id="Blocks">
      <h2 class="text-2xl font-semibold mt-8 mb-3">ðŸ“‚ Blocks</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="BlocksGrid"></div>
    </section>
    <section id="Themes">
      <h2 class="text-2xl font-semibold mt-8 mb-3">ðŸ“‚ Themes</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="ThemesGrid"></div>
    </section>
    <section id="Subscriptions">
      <h2 class="text-2xl font-semibold mt-8 mb-3">ðŸ“‚ Subscription Boxes</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="SubscriptionsGrid"></div>
    </section>
    <section id="Misc">
      <h2 class="text-2xl font-semibold mt-8 mb-3">ðŸ“‚ Misc</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="MiscGrid"></div>
    </section>
  </div>

<script>
const uploadInput = document.getElementById('uploadInput');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');

uploadInput.addEventListener('change', handleUpload);

async function handleUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  progressContainer.classList.remove('hidden');
  progressBar.style.width = "0%";

  const reader = new FileReader();
  reader.onload = async function(e) {
    const data = e.target.result;
    const zip = await JSZip.loadAsync(data);
    let category = "Misc";
    let htmlFile = null;

    // Detect category and find index.html
    zip.forEach((relativePath, zipEntry) => {
      if (relativePath.includes("templates/")) category = "Templates";
      else if (relativePath.includes("blocks/")) category = "Blocks";
      else if (relativePath.includes("themes/")) category = "Themes";
      else if (relativePath.includes("subscriptions/")) category = "Subscriptions";
      if (relativePath.endsWith("index.html")) htmlFile = zipEntry;
    });

    let thumbnail = null;
    if (htmlFile) {
      const htmlContent = await htmlFile.async("text");
      thumbnail = await generateScreenshot(htmlContent);
    } else {
      thumbnail = "https://via.placeholder.com/400x300?text=No+Preview";
    }

    addToLibrary(file.name.replace(".zip",""), category, thumbnail);
    progressBar.style.width = "100%";
    setTimeout(()=> progressContainer.classList.add('hidden'), 800);
  };
  reader.readAsArrayBuffer(file);
}

async function generateScreenshot(htmlContent) {
  return new Promise(resolve => {
    const iframe = document.createElement("iframe");
    iframe.style.position = "absolute";
    iframe.style.left = "-9999px";
    document.body.appendChild(iframe);
    iframe.contentDocument.open();
    iframe.contentDocument.write(htmlContent);
    iframe.contentDocument.close();

    iframe.onload = () => {
      html2canvas(iframe.contentDocument.body).then(canvas => {
        const dataURL = canvas.toDataURL("image/png");
        document.body.removeChild(iframe);
        resolve(dataURL);
      });
    };
  });
}

function addToLibrary(name, category, thumbnail) {
  const grid = document.getElementById(category + "Grid") || document.getElementById("MiscGrid");
  
  const card = document.createElement("div");
  card.className = "border rounded-lg p-3 bg-white shadow";

  card.innerHTML = `
    <div class="relative overflow-hidden border h-48 flex items-center justify-center bg-gray-100">
      <img src="${thumbnail}" class="draggable max-w-none select-none cursor-move" style="transform: translate(0px,0px) scale(1);" />
    </div>
    <div class="flex justify-between mt-2">
      <span class="font-medium">${name}</span>
      <button class="text-red-600 text-sm">Delete</button>
    </div>
    <div class="flex gap-2 mt-2">
      <button class="zoomIn bg-black text-white px-2 py-1 text-xs rounded">+</button>
      <button class="zoomOut bg-black text-white px-2 py-1 text-xs rounded">-</button>
      <button class="saveThumb bg-black text-white px-2 py-1 text-xs rounded">Save</button>
    </div>
  `;

  // Dragging + zoom logic
  const img = card.querySelector("img");
  let pos = {x:0, y:0}, dragging = false;

  img.addEventListener("mousedown", e => {
    dragging = true;
    pos = { x: e.clientX - img.offsetLeft, y: e.clientY - img.offsetTop };
  });
  document.addEventListener("mouseup", ()=> dragging=false);
  document.addEventListener("mousemove", e => {
    if (dragging) {
      img.style.transform = `translate(${e.clientX-pos.x}px,${e.clientY-pos.y}px) scale(${currentScale(img)})`;
    }
  });

  card.querySelector(".zoomIn").onclick = () => zoom(img, 0.1);
  card.querySelector(".zoomOut").onclick = () => zoom(img, -0.1);
  card.querySelector(".saveThumb").onclick = () => alert("Thumbnail saved for " + name);
  card.querySelector("button.text-red-600").onclick = () => card.remove();

  grid.appendChild(card);
}

function currentScale(img){
  const match = img.style.transform.match(/scale\(([^)]+)\)/);
  return match ? parseFloat(match[1]) : 1;
}
function zoom(img, delta){
  let scale = currentScale(img)+delta;
  if (scale<0.2) scale=0.2;
  if (scale>3) scale=3;
  const match = img.style.transform.match(/translate\(([^)]+)\)/);
  let translate = match ? match[1] : "0px,0px";
  img.style.transform = `translate(${translate}) scale(${scale})`;
}
</script>
</body>
</html>
