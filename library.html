<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sitegen — Library</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h1 { font-size: 20px; }
    button {
      background: #000;
      color: #fff;
      border: none;
      padding: 5px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover { opacity: 0.8; }
    .upload-section, .library {
      margin-bottom: 20px;
    }
    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    .library-item {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      border-radius: 6px;
      background: #fafafa;
    }
    .library-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      margin-bottom: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Sitegen — Library</h1>
    <button onclick="window.location.href='index.html'">Home</button>
  </header>

  <section class="upload-section">
    <h2>Upload New Item</h2>
    <label>Category:
      <select id="category">
        <option value="templates">Template</option>
        <option value="blocks">Block</option>
        <option value="themes">Theme</option>
        <option value="subscriptions">Subscription</option>
      </select>
    </label><br><br>
    <input type="file" id="fileInput" accept=".html,.zip"><br><br>
    <button onclick="uploadItem()">Upload</button>
  </section>

  <section class="library">
    <h2>Library Items</h2>
    <div class="library-grid" id="libraryGrid"></div>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const fallbackImage =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAQAAACENnwnAAAAMUlEQVR42mP8z8AARLHwHzAyMiBAVWAAqXFAF5xAA1QgB8gGgYE2IMoCqYGkEXMQUk4yMIhAzgAAB3TBKPG/Xd8AAAAASUVORK5CYII=";

    function getLibrary() {
      return JSON.parse(localStorage.getItem("sitegen_library") || 
        '{"templates":[],"blocks":[],"themes":[],"subscriptions":[]}');
    }

    function saveLibrary(data) {
      localStorage.setItem("sitegen_library", JSON.stringify(data));
    }

    function renderLibrary() {
      const data = getLibrary();
      const grid = document.getElementById("libraryGrid");
      grid.innerHTML = "";

      Object.keys(data).forEach(category => {
        data[category].forEach((item, i) => {
          const div = document.createElement("div");
          div.className = "library-item";

          const img = document.createElement("img");
          img.src = item.thumbnail || fallbackImage;

          const name = document.createElement("p");
          name.textContent = item.name;

          const cat = document.createElement("small");
          cat.textContent = category.charAt(0).toUpperCase() + category.slice(1);

          const btn = document.createElement("button");
          btn.textContent = "Remove";
          btn.onclick = () => {
            data[category].splice(i, 1);
            saveLibrary(data);
            renderLibrary();
          };

          div.appendChild(img);
          div.appendChild(name);
          div.appendChild(cat);
          div.appendChild(document.createElement("br"));
          div.appendChild(btn);

          grid.appendChild(div);
        });
      });
    }

    function uploadItem() {
      const fileInput = document.getElementById("fileInput");
      const category = document.getElementById("category").value;
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = getLibrary();

        // Generate screenshot thumbnail from uploaded HTML (if possible)
        let thumbnail = fallbackImage;
        try {
          const iframe = document.createElement("iframe");
          iframe.style.display = "none";
          document.body.appendChild(iframe);
          iframe.contentDocument.write(e.target.result);
          await new Promise(res => setTimeout(res, 300));
          const canvas = await html2canvas(iframe.contentDocument.body);
          thumbnail = canvas.toDataURL();
          document.body.removeChild(iframe);
        } catch (err) {
          console.warn("Screenshot failed, using fallback", err);
        }

        data[category].push({
          name: file.name.replace(/\.[^/.]+$/, ""),
          content: e.target.result,
          thumbnail
        });

        saveLibrary(data);
        renderLibrary();
      };
      reader.readAsText(file);
    }

    renderLibrary();
  </script>
</body>
</html>
